(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{422:function(t,a,s){"use strict";s.r(a);var n=s(4),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h4",{attrs:{id:"事务模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务模型"}},[t._v("#")]),t._v(" 事务模型")]),t._v(" "),a("p",[t._v("Spring通过统一的编程模型（即抽象接口）来支持jdbc、jta、jpa、hibernate等不同的事务")]),t._v(" "),a("ol",[a("li",[a("p",[a("code",[t._v("PlatformTransactionManager")]),t._v("接口")]),t._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PlatformTransactionManager")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回当前事务或者创建一个新的，这取决于事务的传播方式")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionStatus")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTransaction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionDefinition")]),t._v(" definition"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 提交事务")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionStatus")]),t._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 回滚事务")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rollback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionStatus")]),t._v(" status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("p",[t._v("具体的实现类有管理JDBC的"),a("code",[t._v("DataSourceTransactionManager")]),t._v("，jta的"),a("code",[t._v("JtaTransactionManager")])])]),t._v(" "),a("li",[a("p",[a("code",[t._v("TransactionDefinition")]),t._v("接口")]),t._v(" "),a("p",[t._v("定义事务的属性")]),t._v(" "),a("ul",[a("li",[a("em",[t._v("Isolation")]),t._v(": The degree to which this transaction is isolated from the work of other transactions. For example, can this transaction see uncommitted writes from other transactions?")]),t._v(" "),a("li",[a("em",[t._v("Propagation")]),t._v(": Typically, all code executed within a transaction scope will run in that transaction. However, you have the option of specifying the behavior in the event that a transactional method is executed when a transaction context already exists. For example, code can continue running in the existing transaction (the common case); or the existing transaction can be suspended and a new transaction created. "),a("em",[t._v("Spring offers all of the transaction propagation options familiar from EJB CMT")]),t._v(". To read about the semantics of transaction propagation in Spring, see "),a("a",{attrs:{href:"https://docs.spring.io/spring-framework/docs/4.2.x/spring-framework-reference/html/transaction.html#tx-propagation",target:"_blank",rel:"noopener noreferrer"}},[t._v("Section 16.5.7, “Transaction propagation”"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("li",[a("em",[t._v("Timeout")]),t._v(": How long this transaction runs before timing out and being rolled back automatically by the underlying transaction infrastructure.")]),t._v(" "),a("li",[a("em",[t._v("Read-only status")]),t._v(": A read-only transaction can be used when your code reads but does not modify data. Read-only transactions can be a useful optimization in some cases, such as when you are using Hibernate.")])])]),t._v(" "),a("li",[a("p",[a("code",[t._v("TransactionStatus")]),t._v("接口")]),t._v(" "),a("p",[t._v("表示事务的状态")]),t._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionStatus")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SavepointManager")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isNewTransaction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hasSavepoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setRollbackOnly")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isRollbackOnly")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("flush")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isCompleted")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br")])])])]),t._v(" "),a("h4",{attrs:{id:"事务编程分类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务编程分类"}},[t._v("#")]),t._v(" 事务编程分类")]),t._v(" "),a("h5",{attrs:{id:"声明式事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#声明式事务"}},[t._v("#")]),t._v(" 声明式事务")]),t._v(" "),a("p",[t._v("基于Spring的AOP（面向切面编程）功能，允许开发者在方法或类级别上声明事务行为，而无需在代码中编写大量的事务管理代码。")]),t._v(" "),a("p",[t._v("通过XML/注解的方式来配置事务管理的属性")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/soda1/img/main/20230624001831.png",alt:""}})]),t._v(" "),a("center",[t._v("实现原理图")]),t._v(" "),a("p",[a("strong",[t._v("注解方式配置")])]),t._v(" "),a("ul",[a("li",[a("p",[a("code",[t._v("@EnableTransactionManagement")])]),t._v(" "),a("p",[t._v("加载配置类上，表示开启事务管理")])]),t._v(" "),a("li",[a("p",[a("code",[t._v("@Transaction")])]),t._v(" "),a("p",[t._v("@Transaction注解可以加在方法及类上，添加在类上表示所有的公共方法具有相同的事务事务属性")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("属性名")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("name")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("当在配置文件中有多个 TransactionManager , 可以用该属性指定选择哪个事务管理器。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("propagation")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务的传播行为，默认值为 REQUIRED。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("isolation")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务的隔离度，默认值采用 DEFAULT。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("timeout")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务的超时时间，默认值为-1。如果超过该时间限制但事务还没有完成，则自动回滚事务。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("read-only")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("指定事务是否为只读事务，默认值为 false；为了忽略那些不需要事务的方法，比如读取数据，可以设置 read-only 为 true。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("rollback-for")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("用于指定能够触发事务回滚的异常类型，如果有多个异常类型需要指定，各类型之间可以通过逗号分隔。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("no-rollback- for")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("抛出 no-rollback-for 指定的异常类型，不回滚事务。")])])])])])]),t._v(" "),a("h5",{attrs:{id:"编程式事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编程式事务"}},[t._v("#")]),t._v(" 编程式事务")]),t._v(" "),a("ul",[a("li",[t._v("使用"),a("code",[t._v("TransactionTemplate")])]),t._v(" "),a("li",[t._v("直接使用"),a("code",[t._v("PlatformTransactionManager")]),t._v("实现类")])]),t._v(" "),a("h4",{attrs:{id:"事务隔离类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务隔离类型"}},[t._v("#")]),t._v(" 事务隔离类型")]),t._v(" "),a("ol",[a("li",[a("strong",[t._v("DEFAULT（默认）")]),t._v("：使用底层数据库的默认隔离级别。对于大多数数据库，通常是READ_COMMITTED。")]),t._v(" "),a("li",[a("strong",[t._v("READ_UNCOMMITTED（读取未提交数据）")]),t._v("：最低的隔离级别。允许一个事务读取另一个事务尚未提交的数据。可能会导致脏读、不可重复读和幻读问题。")]),t._v(" "),a("li",[a("strong",[t._v("READ_COMMITTED（读取已提交数据）")]),t._v("：要求一个事务只能读取已经提交的数据。可以避免脏读问题，但仍可能遇到不可重复读和幻读问题。")]),t._v(" "),a("li",[a("strong",[t._v("REPEATABLE_READ（可重复读）")]),t._v("：要求一个事务在同一查询中多次读取同样的数据时，结果保持一致。可以避免脏读和不可重复读问题，但仍可能遇到幻读问题。")]),t._v(" "),a("li",[a("strong",[t._v("SERIALIZABLE（串行化）")]),t._v("：最高的隔离级别。要求事务串行执行，完全避免脏读、不可重复读和幻读问题。但由于串行化执行的特性，可能会导致并发性能下降。")])]),t._v(" "),a("h4",{attrs:{id:"事务传播类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务传播类型"}},[t._v("#")]),t._v(" 事务传播类型")]),t._v(" "),a("ul",[a("li",[t._v("PROPAGATION_REQUIRED -- 支持当前事务，如果当前没有事务，就新建一个事务。这是最常见的选择。")]),t._v(" "),a("li",[t._v("PROPAGATION_SUPPORTS -- 支持当前事务，如果当前没有事务，就以非事务方式执行。")]),t._v(" "),a("li",[t._v("PROPAGATION_MANDATORY -- 支持当前事务，如果当前没有事务，就抛出异常。")]),t._v(" "),a("li",[t._v("PROPAGATION_REQUIRES_NEW -- 新建事务，如果当前存在事务，把当前事务挂起。")]),t._v(" "),a("li",[t._v("PROPAGATION_NOT_SUPPORTED -- 以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。")]),t._v(" "),a("li",[t._v("PROPAGATION_NEVER -- 以非事务方式执行，如果当前存在事务，则抛出异常。")]),t._v(" "),a("li",[t._v("PROPAGATION_NESTED -- 如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则进行与PROPAGATION_REQUIRED类似的操作。")])]),t._v(" "),a("h4",{attrs:{id:"多数据源事务管理实例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多数据源事务管理实例"}},[t._v("#")]),t._v(" 多数据源事务管理实例")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("配置多数据源")]),t._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//数据源1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Bean")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DataSource")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dataSource1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tomcat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jdbc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("DataSource")]),t._v(" dataSource "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tomcat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jdbc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("DataSource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setDriverClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"com.mysql.jdbc.Driver"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setUrl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jdbc:mysql://localhost:3306/ds1?characterEncoding=UTF-8"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setUsername")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setPassword")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root123"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInitialSize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//数据源2")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Bean")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DataSource")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dataSource2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tomcat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jdbc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("DataSource")]),t._v(" dataSource "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tomcat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jdbc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("DataSource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setDriverClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"com.mysql.jdbc.Driver"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setUrl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jdbc:mysql://localhost:3306/ds2?characterEncoding=UTF-8"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setUsername")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setPassword")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root123"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInitialSize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" dataSource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br")])])]),t._v(" "),a("li",[a("p",[t._v("配置数据源事务管理器")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('//事务管理器1，对应数据源1\n@Bean\npublic PlatformTransactionManager transactionManager1(@Qualifier("dataSource1")DataSource dataSource) {\n    return new DataSourceTransactionManager(dataSource);\n}\n//事务管理器2，对应数据源2\n@Bean\npublic PlatformTransactionManager transactionManager2(@Qualifier("dataSource2")DataSource dataSource) {\n    return new DataSourceTransactionManager(dataSource);\n}\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])])]),t._v(" "),a("li",[a("p",[t._v("@Transaction配置使用的事务管理器")]),t._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("transactionManager "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"transactionManager1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" propagation "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Propagation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REQUIRED")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("required")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jdbcTemplate1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("update")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"insert into user1(name) VALUES (?)"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])])])]),t._v(" "),a("h4",{attrs:{id:"事务工具类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务工具类"}},[t._v("#")]),t._v(" 事务工具类")]),t._v(" "),a("p",[a("code",[t._v("TransactionSynchronizationManager")]),t._v("：事务同步管理器，一般可以使用此类注册事务提交后的回调函数。"),a("a",{attrs:{href:"https://www.jianshu.com/p/4b5eb29cc6d9",target:"_blank",rel:"noopener noreferrer"}},[t._v("Spring进阶篇（7）-TransactionSynchronizationManager(事务监听)"),a("OutboundLink")],1)]),t._v(" "),a("h4",{attrs:{id:"事务失效场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务失效场景"}},[t._v("#")]),t._v(" 事务失效场景")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("没有配置需要回滚的异常")]),t._v(" "),a("p",[t._v("由于回滚只发生在"),a("code",[t._v("runtime")]),t._v("阶段，当发生异常时，spring只会对unchecked的异常进行回滚。因此如果要对checked异常也进行回滚，需要在"),a("code",[t._v("@transaction")]),t._v("进行配置"),a("code",[t._v("rollbackFor")]),t._v("属性")])]),t._v(" "),a("li",[a("p",[t._v("对私有方法加"),a("code",[t._v("@transaction")]),t._v("注解")]),t._v(" "),a("p",[t._v("声明式事务只支持public")])]),t._v(" "),a("li",[a("p",[t._v("使用了多线程")]),t._v(" "),a("p",[t._v("事务是基于线程去管理的，如果在业务方法中使用了异步，那么事务会失效")])]),t._v(" "),a("li",[a("p",[t._v("类方法间的调用")]),t._v(" "),a("p",[t._v("如果没有加"),a("code",[t._v("@transaction")]),t._v("的方法A调用了加"),a("code",[t._v("@transaction")]),t._v("的方法B，那么事务是不会生效的。因为声明式事务是基于AOP代理")])]),t._v(" "),a("li",[a("p",[t._v("事务拦截器优先级问题")]),t._v(" "),a("p",[t._v("当定义了多个AOP拦截器时，如果事务拦截器的优先级比较高，那么可能会在发生异常前就已经将事务提交了，导致没有回滚。一般会将事务拦截器的优先级降低")])])]),t._v(" "),a("p",[t._v("参考：")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://docs.spring.io/spring-framework/docs/4.2.x/spring-framework-reference/html/transaction.html",title:"Transaction Management",target:"_blank",rel:"noopener noreferrer"}},[t._v(" Transaction Management"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"http://www.itsoku.com/course/12/128",title:"多数据源事务使用2个步骤",target:"_blank",rel:"noopener noreferrer"}},[t._v("多数据源事务使用2个步骤"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://levelup.gitconnected.com/15-things-you-need-to-know-when-you-want-to-use-spring-transactional-really-well-fc6f5ec207ac",title:"15+ things you need to know when you want to use Spring @Transactional really well",target:"_blank",rel:"noopener noreferrer"}},[t._v("15+ things you need to know when you want to use Spring @Transactional really well"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"http://www.itsoku.com/course/12/128",title:"多数据源事务使用2个步骤",target:"_blank",rel:"noopener noreferrer"}},[a("OutboundLink")],1)])],1)}),[],!1,null,null,null);a.default=e.exports}}]);