(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{419:function(s,t,a){"use strict";a.r(t);var e=a(4),r=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h3",{attrs:{id:"慢查询日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#慢查询日志"}},[s._v("#")]),s._v(" 慢查询日志")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句")])]),s._v(" "),t("li",[t("p",[s._v("具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10，意思是运行10秒以上的语句。")])]),s._v(" "),t("li",[t("p",[s._v("由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合之前explain进行全面分析。")])]),s._v(" "),t("li",[t("p",[s._v("相关变量")]),s._v(" "),t("ul",[t("li",[s._v("slow_query_log： 慢查询日志开启")]),s._v(" "),t("li",[s._v("long_query_time： 日志记录sql语句的时间阈值，sql执行时间"),t("strong",[s._v("大于")]),s._v("该时间就会记录")]),s._v(" "),t("li",[s._v("slow_query_log_file：日志记录位置")]),s._v(" "),t("li",[s._v("Slow_queries：当前慢查询日志记录的sql语句记录条数")])]),s._v(" "),t("p",[s._v("可以在配置文件中进行永久配置，也可以在命令端配置")])])]),s._v(" "),t("h3",{attrs:{id:"日志分析工具mysqldumpslow"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#日志分析工具mysqldumpslow"}},[s._v("#")]),s._v(" 日志分析工具mysqldumpslow")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("命令参数")]),s._v(" "),t("ul",[t("li",[s._v("s: 是表示按照何种方式排序")]),s._v(" "),t("li",[s._v("c: 访问次数")]),s._v(" "),t("li",[s._v("l: 锁定时间")]),s._v(" "),t("li",[s._v("r: 返回记录")]),s._v(" "),t("li",[s._v("t: 查询行数")]),s._v(" "),t("li",[s._v("al:平均锁定时间")]),s._v(" "),t("li",[s._v("ar:平均返回记录数")]),s._v(" "),t("li",[s._v("at:平均查询时间")]),s._v(" "),t("li",[s._v("t:即为返回前面多少条的数据")]),s._v(" "),t("li",[s._v("g:后边搭配一个正则匹配模式，大小写不敏感的")])])]),s._v(" "),t("li",[t("p",[s._v("工作中常用命令")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("得到返回记录集最多的"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("个"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SQL")]),s._v("\nmysqldumpslow "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s r "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("var"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("atguigu"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("slow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\n得到访问次数最多的"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("个"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SQL")]),s._v("\nmysqldumpslow "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("var"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("atguigu"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("slow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\n得到按照时间排序的前"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("条里面含有左连接的查询语句\nmysqldumpslow "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s t "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("g "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"left join"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("var"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("atguigu"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("slow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\n另外建议在使用这些命令时结合 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 和more 使用 ，否则有可能出现爆屏情况\nmysqldumpslow "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s r "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("var"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("atguigu"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("slow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" more\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"show-profile"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#show-profile"}},[s._v("#")]),s._v(" Show Profile")]),s._v(" "),t("p",[s._v("mysql提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于SQL的调优的测量")]),s._v(" "),t("p",[s._v("默认情况下，参数处于关闭状态，并保存最近15次的运行结果")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("开启")]),s._v(" "),t("p",[t("code",[s._v("set profiling=1;")])])]),s._v(" "),t("li",[t("p",[s._v("查看记录的sql")]),s._v(" "),t("p",[t("code",[s._v("show profiles;")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/soda1/img/main/image-20201116204847285.png",alt:"image-20201116204847285"}})])]),s._v(" "),t("li",[t("p",[s._v("诊断sql")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" profiling "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" query n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- n 为Query_ID; ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- type参数：")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- ALL                        --显示所有的开销信息  ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- BLOCK IO                   --显示块IO相关开销  ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- CONTEXT SWITCHES \t\t  --上下文切换相关开销  ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- CPU              \t\t  --显示CPU相关开销信息  ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- IPC              \t\t  --显示发送和接收相关开销信息  ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- MEMORY           \t\t  --显示内存相关开销信息  ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- PAGE FAULTS      \t\t  --显示页面错误相关开销信息  ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- SOURCE           \t      --显示和Source_function，Source_file，Source_line相关的开销信息  ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- SWAPS              \t\t  --显示交换次数相关开销的信息")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/soda1/img/main/image-20201116204950949.png"}})]),s._v(" "),t("li",[t("p",[s._v("日常开发需要注意"),t("code",[s._v("show profile")]),s._v("中的status")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("converting HEAP to MyISAM")]),s._v(" 查询结果太大，内存都不够用了往磁盘上搬了。")]),s._v(" "),t("li",[t("code",[s._v("creating tmp table")]),s._v(" 创建临时表")]),s._v(" "),t("li",[t("code",[s._v("copying to tmp table on disk")]),s._v(" 把内存中临时表复制到磁盘，危险！！！")]),s._v(" "),t("li",[t("code",[s._v("locked")])])])])]),s._v(" "),t("h3",{attrs:{id:"全局查询日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#全局查询日志"}},[s._v("#")]),s._v(" 全局查询日志")]),s._v(" "),t("p",[s._v("尽量不要在生产环境开启这个功能")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("配置启用")]),s._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在mysql的my.cnf中，设置如下：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("general_log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 记录日志文件的路径")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("general_log_file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/path/logfile")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#输出格式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log_output")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("FILE")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("编码启用")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" general_log"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#全局日志可以存放到日志文件中，也可以存放到Mysql系统表中。存放到日志中性能更好一些，存储到表中")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" log_output"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'TABLE'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n此后 ，你所编写的"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sql")]),s._v("语句，将会记录到mysql库里的general_log表，可以用下面的命令查看\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("general_log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])])])])}),[],!1,null,null,null);t.default=r.exports}}]);