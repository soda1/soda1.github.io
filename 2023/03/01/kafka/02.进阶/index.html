<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Eric"><meta name="copyright" content="Eric"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>KafkaËøõÈò∂ | Eric's blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link class="aplayer-style-marker" rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.css"><script class="aplayer-script-marker" src="https://fastly.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.js" defer></script><script class="meting-script-marker" src="https://fastly.jsdelivr.net/npm/meting@1/dist/Meting.min.js" defer></script><script src="https://fastly.jsdelivr.net/npm/pjax@latest/pjax.min.js" defer></script><script src="/js/pjax.js" defer type="module"></script><script src="https://fastly.jsdelivr.net/npm/vue@2.6.14"></script><link rel="icon" type="image/png" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="prefetch" href="/js/sakura.js" as="script"><link rel="prefetch" href="/js/load-aplayer.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"soda1.github.io","root":"/","title":"Eric„ÅÆÂ∞èÂ±ã","version":"1.10.9","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="Eric's blog" type="application/atom+xml"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js" defer></script><script src="/js/load-aplayer.js" defer></script><meta name="description" content="ÂàÜÂå∫Êú∫Âà∂ÂàÜÂå∫ÁöÑ‰ΩúÁî®‰∏ªË¶ÅÊòØ‰∏∫‰∫ÜÊèêÈ´òË¥üËΩΩÂùáË°°ÁöÑËÉΩÂäõÔºåÊï∞ÊçÆÁöÑËØªÂÜôÈÉΩÊòØÂú®ÂàÜÂå∫Ëøô‰∏™Á≤íÂ∫¶‰∏äËøõË°åÁöÑÔºå‰ªéËÄåÂÆûÁé∞‰∫ÜÁ≥ªÁªüÁöÑÂèØ‰º∏Áº©ÊÄß ÂàÜÂå∫Á≠ñÁï•ÂàÜÂå∫Á≠ñÁï•ÂÜ≥ÂÆöËÄÖÁîü‰∫ßËÄÖÂ∞ÜÊ∂àÊÅØÂèëÈÄÅËá≥Âì™‰∏™Âå∫ÔºåÂ¶ÇÊûúÁîü‰∫ßËÄÖË¶ÅÂÆö‰πâ‰∏Ä‰∏™ÂàÜÂå∫Á≠ñÁï•ÔºåË¶ÅÂú®ÂÆ¢Êà∑Á´ØÂÆûÁé∞org.apache.kafka.clients.producer.PartitionerÊé•Âè£ÔºåÂ∏∏ËßÅÂàÜÂå∫Á≠ñÁï•Â¶Ç‰∏ãÔºö  ËΩÆËØ¢Á≠ñÁï•Ôºà Round-robinÔºâ KafkaÈªòËÆ§Á≠ñÁï•ÔºåÈ°∫Â∫èÂàÜÈÖçÔºåÂ∞±ÊòØÂèñ‰ΩôÊìç">
<meta property="og:type" content="article">
<meta property="og:title" content="KafkaËøõÈò∂">
<meta property="og:url" content="http://soda1.github.io/2023/03/01/kafka/02.%E8%BF%9B%E9%98%B6/index.html">
<meta property="og:site_name" content="Eric&#39;s blog">
<meta property="og:description" content="ÂàÜÂå∫Êú∫Âà∂ÂàÜÂå∫ÁöÑ‰ΩúÁî®‰∏ªË¶ÅÊòØ‰∏∫‰∫ÜÊèêÈ´òË¥üËΩΩÂùáË°°ÁöÑËÉΩÂäõÔºåÊï∞ÊçÆÁöÑËØªÂÜôÈÉΩÊòØÂú®ÂàÜÂå∫Ëøô‰∏™Á≤íÂ∫¶‰∏äËøõË°åÁöÑÔºå‰ªéËÄåÂÆûÁé∞‰∫ÜÁ≥ªÁªüÁöÑÂèØ‰º∏Áº©ÊÄß ÂàÜÂå∫Á≠ñÁï•ÂàÜÂå∫Á≠ñÁï•ÂÜ≥ÂÆöËÄÖÁîü‰∫ßËÄÖÂ∞ÜÊ∂àÊÅØÂèëÈÄÅËá≥Âì™‰∏™Âå∫ÔºåÂ¶ÇÊûúÁîü‰∫ßËÄÖË¶ÅÂÆö‰πâ‰∏Ä‰∏™ÂàÜÂå∫Á≠ñÁï•ÔºåË¶ÅÂú®ÂÆ¢Êà∑Á´ØÂÆûÁé∞org.apache.kafka.clients.producer.PartitionerÊé•Âè£ÔºåÂ∏∏ËßÅÂàÜÂå∫Á≠ñÁï•Â¶Ç‰∏ãÔºö  ËΩÆËØ¢Á≠ñÁï•Ôºà Round-robinÔºâ KafkaÈªòËÆ§Á≠ñÁï•ÔºåÈ°∫Â∫èÂàÜÈÖçÔºåÂ∞±ÊòØÂèñ‰ΩôÊìç">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303190703.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303190823.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303192421.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303192537.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303160430.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230305165243.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230305165811.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230305172705.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230305235446.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230306010801.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230306151424.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303184103.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230304145246.png">
<meta property="article:published_time" content="2023-03-01T15:15:20.000Z">
<meta property="article:modified_time" content="2023-03-06T19:56:48.000Z">
<meta property="article:author" content="Eric">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303190703.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Eric"><img width="96" loading="lazy" src="/yun.png" alt="Eric"><span class="site-author-status" title="ÁÉ≠Áà±ÂèØÊäµÂ≤ÅÊúàÊº´Èïø">üòä</span></a><div class="site-author-name"><a href="/about/">Eric</a></div><span class="site-name">Eric's blog</span><sub class="site-subtitle"></sub><div class="site-description">The best way is to get your hands dirty</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">72</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">11</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">0</span></a></div><a class="site-state-item hty-icon-button" href="/about" title="About"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E6%9C%BA%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">ÂàÜÂå∫Êú∫Âà∂</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5"><span class="toc-number">1.1.</span> <span class="toc-text">ÂàÜÂå∫Á≠ñÁï•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%A7%A3%E5%8E%8B%E7%BC%A9"><span class="toc-number">2.</span> <span class="toc-text">Ê∂àÊÅØËß£ÂéãÁº©</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">Êó†Ê∂àÊÅØ‰∏¢Â§±ÈÖçÁΩÆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">Êã¶Êà™Âô®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Producer%E4%B8%80%E6%AC%A1%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">Producer‰∏ÄÊ¨°ÂèëÈÄÅÊµÅÁ®ã</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Message-Delivery-Semantics"><span class="toc-number">6.</span> <span class="toc-text">Message Delivery Semantics</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Kafka%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81exactly-once"><span class="toc-number">6.1.</span> <span class="toc-text">KafkaÂ¶Ç‰Ωï‰øùËØÅexactly once</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">6.1.1.</span> <span class="toc-text">ÂπÇÁ≠âÊÄß</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">6.1.2.</span> <span class="toc-text">‰∫ãÂä°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%9C%BA%E5%88%B6"><span class="toc-number">7.</span> <span class="toc-text">Ê∂àË¥πÊú∫Âà∂</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Consumer-Group"><span class="toc-number">7.1.</span> <span class="toc-text">Consumer Group</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%A4%E5%A4%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">7.1.1.</span> <span class="toc-text">ÂÆûÁé∞‰∏§Â§ßÊ®°Âûã</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Standalone-Consumer"><span class="toc-number">7.2.</span> <span class="toc-text">Standalone Consumer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#consumer-offsets"><span class="toc-number">7.3.</span> <span class="toc-text">_consumer_offsets</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Coordinator%E7%BB%84%E4%BB%B6"><span class="toc-number">7.4.</span> <span class="toc-text">CoordinatorÁªÑ‰ª∂</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Rebalance"><span class="toc-number">7.5.</span> <span class="toc-text">Rebalance</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Rebalance%E8%A6%81%E7%82%B9"><span class="toc-number">7.5.1.</span> <span class="toc-text">RebalanceË¶ÅÁÇπ</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Consumer%E9%87%8D%E5%B9%B3%E8%A1%A1%E6%AD%A5%E9%AA%A4"><span class="toc-number">7.5.2.</span> <span class="toc-text">ConsumerÈáçÂπ≥Ë°°Ê≠•È™§</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%8D%E7%A7%BB%E6%8F%90%E4%BA%A4"><span class="toc-number">7.6.</span> <span class="toc-text">‰ΩçÁßªÊèê‰∫§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Consumer%E5%BB%BA%E7%AB%8BTCP%E8%BF%9E%E6%8E%A5%E7%A7%8D%E7%B1%BB"><span class="toc-number">7.7.</span> <span class="toc-text">ConsumerÂª∫Á´ãTCPËøûÊé•ÁßçÁ±ª</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%BF%9B%E5%BA%A6%E7%9B%91%E6%8E%A7"><span class="toc-number">7.8.</span> <span class="toc-text">Ê∂àË¥πËøõÂ∫¶ÁõëÊéß</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E6%9C%BA%E5%88%B6"><span class="toc-number">8.</span> <span class="toc-text">ÂâØÊú¨Êú∫Âà∂</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#In-sync-Replicas%EF%BC%88ISR%EF%BC%89"><span class="toc-number">8.1.</span> <span class="toc-text">In-sync ReplicasÔºàISRÔºâ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Unclean-Leader-Election"><span class="toc-number">8.2.</span> <span class="toc-text">Unclean Leader Election</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#High-Watermark-HW"><span class="toc-number">8.3.</span> <span class="toc-text">High Watermark(HW)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">8.3.1.</span> <span class="toc-text">Êõ¥Êñ∞Êú∫Âà∂</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Broker"><span class="toc-number">9.</span> <span class="toc-text">Broker</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Broker%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">9.1.</span> <span class="toc-text">BrokerÁΩëÁªúÊ®°Âûã</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller"><span class="toc-number">10.</span> <span class="toc-text">Controller</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">10.1.</span> <span class="toc-text">‰ΩúÁî®</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%80%89%E4%B8%BE"><span class="toc-number">10.2.</span> <span class="toc-text">Â¶Ç‰ΩïÈÄâ‰∏æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86"><span class="toc-number">10.3.</span> <span class="toc-text">Â§±ÊïàÂ§ÑÁêÜ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E8%AE%BE%E8%AE%A1%E7%BB%93%E6%9E%84"><span class="toc-number">10.4.</span> <span class="toc-text">ÂÜÖÈÉ®ËÆæËÆ°ÁªìÊûÑ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81Broker%E5%8F%82%E6%95%B0"><span class="toc-number">11.</span> <span class="toc-text">Âä®ÊÄÅBrokerÂèÇÊï∞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%AE%BE%E6%B6%88%E8%B4%B9%E7%BB%84%E4%BD%8D%E7%A7%BB"><span class="toc-number">12.</span> <span class="toc-text">ÈáçËÆæÊ∂àË¥πÁªÑ‰ΩçÁßª</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E5%B7%A5%E5%85%B7"><span class="toc-number">13.</span> <span class="toc-text">ËÑöÊú¨Â∑•ÂÖ∑</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://soda1.github.io/2023/03/01/kafka/02.%E8%BF%9B%E9%98%B6/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Eric"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Eric's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">KafkaËøõÈò∂</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <span class="post-meta-icon-text">Posted on</span> <time title="Created: 2023-03-01 15:15:20" itemprop="dateCreated datePublished" datetime="2023-03-01T15:15:20+00:00">2023-03-01</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <span class="post-meta-icon-text">Edited on</span> <time title="Modified: 2023-03-06 19:56:48" itemprop="dateModified" datetime="2023-03-06T19:56:48+00:00">2023-03-06</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="Word count in article">5.8k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="Reading time">22m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Kafka/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Kafka</span></a></span></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h4 id="ÂàÜÂå∫Êú∫Âà∂"><a href="#ÂàÜÂå∫Êú∫Âà∂" class="headerlink" title="ÂàÜÂå∫Êú∫Âà∂"></a>ÂàÜÂå∫Êú∫Âà∂</h4><p>ÂàÜÂå∫ÁöÑ‰ΩúÁî®‰∏ªË¶ÅÊòØ‰∏∫‰∫ÜÊèêÈ´òË¥üËΩΩÂùáË°°ÁöÑËÉΩÂäõÔºåÊï∞ÊçÆÁöÑËØªÂÜôÈÉΩÊòØÂú®ÂàÜÂå∫Ëøô‰∏™Á≤íÂ∫¶‰∏äËøõË°åÁöÑÔºå‰ªéËÄåÂÆûÁé∞‰∫ÜÁ≥ªÁªüÁöÑÂèØ‰º∏Áº©ÊÄß</p>
<h5 id="ÂàÜÂå∫Á≠ñÁï•"><a href="#ÂàÜÂå∫Á≠ñÁï•" class="headerlink" title="ÂàÜÂå∫Á≠ñÁï•"></a>ÂàÜÂå∫Á≠ñÁï•</h5><p>ÂàÜÂå∫Á≠ñÁï•ÂÜ≥ÂÆöËÄÖÁîü‰∫ßËÄÖÂ∞ÜÊ∂àÊÅØÂèëÈÄÅËá≥Âì™‰∏™Âå∫ÔºåÂ¶ÇÊûúÁîü‰∫ßËÄÖË¶ÅÂÆö‰πâ‰∏Ä‰∏™ÂàÜÂå∫Á≠ñÁï•ÔºåË¶ÅÂú®ÂÆ¢Êà∑Á´ØÂÆûÁé∞<code>org.apache.kafka.clients.producer.Partitioner</code>Êé•Âè£ÔºåÂ∏∏ËßÅÂàÜÂå∫Á≠ñÁï•Â¶Ç‰∏ãÔºö</p>
<ul>
<li><p>ËΩÆËØ¢Á≠ñÁï•Ôºà Round-robinÔºâ</p>
<p>KafkaÈªòËÆ§Á≠ñÁï•ÔºåÈ°∫Â∫èÂàÜÈÖçÔºåÂ∞±ÊòØÂèñ‰ΩôÊìç‰ΩúÔºå$ partition_index = n % partition_num $ÔºånË°®Á§∫Á¨¨nÊù°Ê∂àÊÅØ„ÄÇËΩÆËØ¢Á≠ñÁï•ÊúâÁùÄÂæàÂ•ΩÁöÑË¥üËΩΩÂùáË°°Ë°®Áé∞„ÄÇ</p>
</li>
<li><p>ÈöèÊú∫Á≠ñÁï•ÔºàRandomnessÔºâ</p>
<p>ÈöèÊú∫ËøîÂõû‰∏Ä‰∏™partition</p>
</li>
<li><p>ÊåâÊ∂àÊÅØÈîÆ‰øùÂ∫èÁ≠ñÁï•</p>
<p>KafkaÂÖÅËÆ∏‰∏∫ÊØèÊù°Ê∂àÊÅØÈÉΩÂÆö‰πâ‰∏Ä‰∏™Ê∂àÊÅØÈîÆÔºåÂèØ‰ª•ÈÄöËøáÂØπÈîÆËøõË°åhash‰ªéËÄå‰øùÂ≠òÂà∞ÁâπÂÆöÁöÑpartition‰∏≠„ÄÇËøô‰πüÊòØKafkaÁöÑÈªòËÆ§Á≠ñÁï•‰πã‰∏ÄÔºåÂÅáËÆæÂÆ¢Êà∑Á´ØÊ≤°ÊúâËá™ÂÆö‰πâÁ≠ñÁï•ÔºåÂ¶ÇÊûúÊòØÊ∂àÊÅØ‰∏≠Â∏¶ÁùÄKeyÔºåÈÇ£‰πàÂ∞±‰ºöÊâßË°åËøô‰∏™Á≠ñÁï•ÔºåÂê¶ÂàôÂ∞±‰ΩøÁî®ËΩÆËØ¢Á≠ñÁï•</p>
</li>
</ul>
<p>spring bootÂÆûÁé∞‰æãÂ≠ê</p>
<pre><code class="java">public class MyPartitioner implements Partitioner &#123;
    @Override
    public int partition(String s, Object o, byte[] bytes, Object o1, byte[] bytes1, Cluster cluster) &#123;
        List&lt;PartitionInfo&gt; partitionInfos = cluster.availablePartitionsForTopic(s);
        int num = ThreadLocalRandom.current().nextInt(partitionInfos.size());
        System.out.println(num);
        return num;
    &#125;
    .........
&#125;</code></pre>
<p>ÈÖçÁΩÆpartitionerË∑ØÂæÑÔºåËøô‰∏™Âú®yml‰∏≠Ê≤°ÊúâÊâæÂà∞Â±ûÊÄßÔºåÁî®‰ª£Á†ÅÊù•ÈÖçÁΩÆ</p>
<pre><code class="java">    @Bean
    public Map&lt;String, Object&gt; producerConfigs() &#123;
        Map&lt;String, Object&gt; props = new HashMap&lt;&gt;();
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;192.168.3.100:9092&quot;);
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, IntegerSerializer.class);
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        props.put(ProducerConfig.PARTITIONER_CLASS_CONFIG, MyPartitioner.class);
        // See https://kafka.apache.org/documentation/#producerconfigs for more properties
        return props;
    &#125;
    @Bean
    public ProducerFactory&lt;Integer, String&gt; producerFactory() &#123;
        return new DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());
    &#125;
    @Bean
    public KafkaTemplate&lt;Integer, String&gt; kafkaTemplate() &#123;
        return new KafkaTemplate&lt;Integer, String&gt;(producerFactory());
    &#125;</code></pre>
<h4 id="Ê∂àÊÅØËß£ÂéãÁº©"><a href="#Ê∂àÊÅØËß£ÂéãÁº©" class="headerlink" title="Ê∂àÊÅØËß£ÂéãÁº©"></a>Ê∂àÊÅØËß£ÂéãÁº©</h4><ul>
<li><p>ProducerÁ´ØÂéãÁº©</p>
<p>ProducerÂÆ¢Êà∑Á´ØÂºÄÂêØÂéãÁº©ÁÆóÊ≥ïÂè™Ë¶ÅÂú®<code>compression.type</code>ÈÖçÁΩÆÊåáÂÆöÁöÑÁ±ªÂûãÁÆóÊ≥ïÂç≥ÂèØÔºåÂú®ProducerÁ´ØÈÖçÁΩÆÂ•ΩÂ§ÑÂú®‰∫éÊúâÂà©‰∫éÁΩëÁªú‰º†Ëæì</p>
</li>
<li><p>BrokerÁ´ØÂéãÁº©</p>
<p>Broker‰πüÊúâÂèØËÉΩ‰ºöÂØπÊ∂àÊÅØËøõË°åÂéãÁº©ÔºåÊúâÂ¶Ç‰∏ãÊÉÖÂÜµ</p>
<p>ÊÉÖÂÜµ1ÔºöBrokerÁ´ØÂíåProducerÁ´ØÂéãÁº©ÁÆóÊ≥ï‰∏ç‰∏ÄËá¥‰∫ßÁîü</p>
<p>ÊÉÖÂÜµ2ÔºöÂõ†Ê∂àÊÅØÁâàÊú¨‰∏çÂêåÂéüÂõ†ÂèëÁîüÁöÑÂÖºÂÆπÊ†ºÂºèËΩ¨Êç¢‰∫ßÁîü</p>
</li>
<li><p>BrokerÁ´ØËß£Âéã</p>
<p>BrokerÁ´ØÈúÄË¶ÅÂØπÊé•Êî∂Âà∞ÁöÑÊ∂àÊÅØËøõË°åÈ™åËØÅÔºåÊØîÂ¶ÇCRCÊ†°È™åÔºåÂõ†Ê≠§‰ºöËß£ÂéãÊ∂àÊÅØ</p>
</li>
<li><p>ConsumerÁ´ØËß£Âéã</p>
<p>ConsumerÊ∂àË¥πÊ∂àÊÅØÈúÄË¶ÅÂÖàËß£ÂéãËøòÂéüÊ∂àÊÅØ</p>
</li>
</ul>
<p>Ê∂àÊÅØËß£ÂéãÁº©Êï¥‰∏™ÊµÅÁ®ãÂèØ‰ª•Ê¶ÇÂÜµ‰∏∫‰∏ÄÂè•ËØùÔºöProducer Á´ØÂéãÁº©„ÄÅBroker Á´Ø‰øùÊåÅ„ÄÅConsumer Á´ØËß£Âéã„ÄÇ</p>
<p>ÂéãÁº©ÁÆóÊ≥ïÊØîËæÉ</p>
<p>ÂêûÂêêÈáèÔºöLZ4 &gt; Snappy &gt; zstd Âíå GZIP</p>
<p>ÂéãÁº©ÊØîÔºözstd &gt; LZ4 &gt; GZIP &gt; Snappy</p>
<h4 id="Êó†Ê∂àÊÅØ‰∏¢Â§±ÈÖçÁΩÆ"><a href="#Êó†Ê∂àÊÅØ‰∏¢Â§±ÈÖçÁΩÆ" class="headerlink" title="Êó†Ê∂àÊÅØ‰∏¢Â§±ÈÖçÁΩÆ"></a>Êó†Ê∂àÊÅØ‰∏¢Â§±ÈÖçÁΩÆ</h4><p>Producer</p>
<ul>
<li>ProducerÂèëÈÄÅÊ∂àÊÅØË¶Å‰ΩøÁî®Â∏¶ÂõûË∞ÉÁöÑsend(msg, callback)</li>
<li>ProducerËÆæÁΩÆacks=allÔºåË°®Á§∫ÊâÄÊúâin-sync replicasÈÉΩÂ∑≤ÁªèÊé•Êî∂Âà∞Ê∂àÊÅØ‰∫ÜÔºåÊ∂àÊÅØÊâçÁÆóÂèëÈÄÅÊàêÂäü</li>
<li>ProducersËÆæÁΩÆretriesÔºåÊ∂àÊÅØÂèëÈÄÅÂ§±Ë¥•Êó∂Â∫îÂΩìÈáçËØïÂ§öÊ¨°ÔºåËøò‰∏çË°åÂÜçÂè¶‰ΩúÂ§ÑÁêÜ</li>
</ul>
<p>BrokerÁ´Ø</p>
<ul>
<li><p>unclean.leader.election.enable = falseÔºåËêΩÂêéÂ§™Â§öÁöÑÂâØÊú¨‰∏çÂ∫îÂΩìÁ´ûÈÄâleader</p>
</li>
<li><p>replication.factor &gt;= 3ÔºåÂ∞ÜÂâØÊú¨Â§ö‰øùÂ≠òÂá†‰ªΩ</p>
</li>
<li><p>min.insync.replicas &gt; 1ÔºåËøô‰∏™ÈÖçÁΩÆÊòØ‰øùËØÅÂΩìProducerÁöÑack=allÊó∂ÔºåBrokerÁ´ØËá≥Â∞ëÂ≠òÂú®Â§öÂ∞ë‰∏™in-sync replicasÊâçËÉΩËøõË°åÂÜôÂÖ•„ÄÇÂèØÂèÇËÄÉ<a target="_blank" rel="noopener" href="https://accu.org/journals/overload/28/159/kozlovski/" title="Kafka Acks Explained">ÊñáÁ´†</a>„ÄÇ</p>
<p>Ë¶ÅÈÖçÁΩÆreplication.factor &gt; min.insync.replicasÔºåÂê¶Âàô‰∏Ä‰∏™ÂâØÊú¨ÊåÇ‰∫ÜÂàÜÂå∫Â∞±‰∏çÂèØÁî®‰∫Ü„ÄÇÊé®ËçêÊàêreplication.factor = min.insync.replicas + 1</p>
</li>
</ul>
<p>Consumer</p>
<ul>
<li>enable.auto.commitËÆæÁΩÆ‰∏∫falseÔºåÊîπ‰∏∫ÊâãÂä®Êèê‰∫§ÔºåÂπ∂ÈááÁî®ÊâãÂä®Êèê‰∫§‰ΩçÁßª</li>
</ul>
<h4 id="Êã¶Êà™Âô®"><a href="#Êã¶Êà™Âô®" class="headerlink" title="Êã¶Êà™Âô®"></a>Êã¶Êà™Âô®</h4><p>todo</p>
<h4 id="Producer‰∏ÄÊ¨°ÂèëÈÄÅÊµÅÁ®ã"><a href="#Producer‰∏ÄÊ¨°ÂèëÈÄÅÊµÅÁ®ã" class="headerlink" title="Producer‰∏ÄÊ¨°ÂèëÈÄÅÊµÅÁ®ã"></a>Producer‰∏ÄÊ¨°ÂèëÈÄÅÊµÅÁ®ã</h4><p>Ê≠•È™§Â¶Ç‰∏ãÔºö</p>
<ol>
<li>ÊûÑÈÄ†Áîü‰∫ßËÄÖÂØπË±°ÊâÄÈúÄÁöÑÂèÇÊï∞ÂØπË±°</li>
<li>Ê†πÊçÆÂèÇÊï∞ÂàõÂª∫KafkaProducerÂØπË±°ÂÆû‰æã</li>
<li>Ë∞ÉÁî®sendÊñπÊ≥ïÂèëÈÄÅÊ∂àÊÅØ</li>
<li>Ë∞ÉÁî®closeÊñπÊ≥ïÈáäÊîæËµÑÊ∫ê</li>
</ol>
<p>Ê∑±ÂÖ•Ôºö</p>
<ol>
<li>Âú®ÂàõÂª∫KafkaProducerÂØπË±°Êó∂ÂêéÂè∞‰ºöÂàõÂª∫‰∏Ä‰∏™Âêç‰∏∫SeederÁöÑÁ∫øÁ®ãÔºåËØ•Á∫øÁ®ã‰ºö‰∏é bootstrap.serversÈÖçÁΩÆÁöÑÊâÄÊúâBrokerËøõË°åTcpËøûÊé•ÔºåÁî®‰∫éËé∑ÂèñÈõÜÁæ§ÂÖÉÊï∞ÊçÆ‰ø°ÊÅØ„ÄÇ</li>
<li>Producer‰ºöÈÄöËøámetadata.max.age.ms ÂèÇÊï∞Êù•ÂÆöÊúüÂú∞ÂéªÊõ¥Êñ∞ÂÖÉÊï∞ÊçÆ‰ø°ÊÅØÔºåÈªòËÆ§Êó∂5ÂàÜÈíü„ÄÇ</li>
<li>Âú®ÂèëÈÄÅÊ∂àÊÅØÊó∂ÔºåProducer‰ºö‰ªéÂÖÉÊï∞ÊçÆÁºìÂ≠ò‰∏≠ÊâæÂà∞ÈúÄË¶ÅÂèëÈÄÅÁöÑBroker‰ø°ÊÅØÔºåÂª∫Á´ãTcpËøûÊé•Êù•ÂèëÈÄÅ‰ø°ÊÅØ</li>
</ol>
<h4 id="Message-Delivery-Semantics"><a href="#Message-Delivery-Semantics" class="headerlink" title="Message Delivery Semantics"></a>Message Delivery Semantics</h4><p>ÊúâÂ¶Ç‰∏ã‰∏âÁßçËØ≠‰πâ‰øùËØÅÔºö</p>
<ul>
<li><p>ÊúÄÂ§ö‰∏ÄÊ¨°Ôºàat most onceÔºâÔºöÊ∂àÊÅØÂèØËÉΩ‰ºö‰∏¢Â§±Ôºå‰ΩÜÁªù‰∏ç‰ºöË¢´ÈáçÂ§çÂèëÈÄÅ</p>
</li>
<li><p>Ëá≥Â∞ë‰∏ÄÊ¨°Ôºàat least onceÔºâÔºöÊ∂àÊÅØ‰∏ç‰ºö‰∏¢Â§±Ôºå‰ΩÜÊúâÂèØËÉΩË¢´ÈáçÂ§çÂèëÈÄÅ</p>
</li>
<li><p>Á≤æÁ°Æ‰∏ÄÊ¨°Ôºàexactly onceÔºâÔºöÊ∂àÊÅØ‰∏ç‰ºö‰∏¢Â§±Ôºå‰πü‰∏ç‰ºöË¢´ÈáçÂ§çÂèëÈÄÅ</p>
</li>
</ul>
<p>KafkaÈªòËÆ§Êèê‰æõat least onceÁöÑÂèØÈù†ÊÄß‰øùËØÅÔºåÊèê‰æõ‰∫ÜÈáçËØïÁöÑÊú∫Âà∂„ÄÇ</p>
<h5 id="KafkaÂ¶Ç‰Ωï‰øùËØÅexactly-once"><a href="#KafkaÂ¶Ç‰Ωï‰øùËØÅexactly-once" class="headerlink" title="KafkaÂ¶Ç‰Ωï‰øùËØÅexactly once"></a>KafkaÂ¶Ç‰Ωï‰øùËØÅexactly once</h5><h6 id="ÂπÇÁ≠âÊÄß"><a href="#ÂπÇÁ≠âÊÄß" class="headerlink" title="ÂπÇÁ≠âÊÄß"></a>ÂπÇÁ≠âÊÄß</h6><p>Âú®0.11ÁâàÊú¨ÂºÄÂßãÊîØÊåÅÔºåBrokerÁªôÊØè‰∏™ProducerÂàÜÈÖç‰∏Ä‰∏™IDÔºå‰∏îProducerÁöÑÊØèÊù°‰ø°ÊÅØÈÉΩ‰ºöÊúâ‰∏Ä‰∏™Â∫èÂàóÂè∑Áî®Êù•ÂéªÈáç‰ø°ÊÅØ„ÄÇÂèØ‰ª•ÈÄöËøáÊåáÂÆö<code>enable.idempotence=true</code>Êù•ÈÖçÁΩÆÂπÇÁ≠âProducer</p>
<p>KafkaÂè™ËÉΩ‰øùËØÅÂçïÂàÜÂå∫‰∏äÁöÑÂπÇÁ≠âÊÄßÔºåÂç≥‰∏Ä‰∏™ÂπÇÁ≠âÊÄß Producer ËÉΩÂ§ü‰øùËØÅÊüê‰∏™‰∏ªÈ¢òÁöÑ‰∏Ä‰∏™ÂàÜÂå∫ ‰∏ä‰∏çÂá∫Áé∞ÈáçÂ§çÊ∂àÊÅØÔºåÂÆÉÊó†Ê≥ïÂÆûÁé∞Â§ö‰∏™ÂàÜÂå∫ÁöÑÂπÇÁ≠âÊÄß„ÄÇÂÖ∂Ê¨°ÔºåÂÆÉÂè™ËÉΩÂÆûÁé∞Âçï‰ºöËØù‰∏äÁöÑÂπÇÁ≠âÊÄßÔºå‰∏ç ËÉΩÂÆûÁé∞Ë∑®‰ºöËØùÁöÑÂπÇÁ≠âÊÄß„ÄÇËøôÈáåÁöÑ‰ºöËØùÔºå‰Ω†ÂèØ‰ª•ÁêÜËß£‰∏∫ Producer ËøõÁ®ãÁöÑ‰∏ÄÊ¨°ËøêË°å„ÄÇÂΩì‰Ω†ÈáçÂêØ‰∫Ü Producer ËøõÁ®ã‰πãÂêéÔºåËøôÁßçÂπÇÁ≠âÊÄß‰øùËØÅÂ∞±‰∏ßÂ§±‰∫Ü„ÄÇ</p>
<h6 id="‰∫ãÂä°"><a href="#‰∫ãÂä°" class="headerlink" title="‰∫ãÂä°"></a>‰∫ãÂä°</h6><p>‰ªé0.11ÁâàÊú¨ÂºÄÂßãÊîØÊåÅÔºåÈÄöËøá<code>ÁΩÆ isolation.level</code>Êù•ËÆæÁΩÆ‰∫ãÂä°Á∫ßÂà´ÔºåÊúâ‰ª•‰∏ãÂèÇÊï∞</p>
<ul>
<li>read_uncommittedÔºöÈªòËÆ§ÂÄºÔºåË°®ÊòéConsumerÂèØ‰ª•ËØªÂèñ‰∫ãÂä°ÂûãProducerÂÜôÂÖ•ÁöÑ‰ªª‰ΩïÊ∂àÊÅØ</li>
<li>read_committedÔºöË°®Êòé Consumer Âè™‰ºöËØªÂèñ‰∫ãÂä°Âûã Producer ÊàêÂäüÊèê‰∫§‰∫ãÂä°ÂÜôÂÖ•ÁöÑÊ∂à ÊÅØ</li>
</ul>
<p>‰∫ãÂä°ÂûãProducerÈÄöËøáÊµÅÁ®ã‰ª£Á†ÅÊéßÂà∂ÔºåÁ±ª‰ººmysqlÈÇ£Ê†∑(begin, commit)</p>
<p>‰∫ãÂä°ÂèØ‰ª•‰øùËØÅË∑®ÂàÜÂå∫ÔºåË∑®‰ºöËØùÁöÑÂπÇÁ≠â„ÄÇ</p>
<h4 id="Ê∂àË¥πÊú∫Âà∂"><a href="#Ê∂àË¥πÊú∫Âà∂" class="headerlink" title="Ê∂àË¥πÊú∫Âà∂"></a>Ê∂àË¥πÊú∫Âà∂</h4><h5 id="Consumer-Group"><a href="#Consumer-Group" class="headerlink" title="Consumer Group"></a>Consumer Group</h5><p>Consumer Group ÊòØ Kafka Êèê‰æõÁöÑÂèØÊâ©Â±ï‰∏îÂÖ∑ ÊúâÂÆπÈîôÊÄßÁöÑÊ∂àË¥πËÄÖÊú∫Âà∂„ÄÇÊØè‰∏™ÁªÑÈÉΩÊúâ‰∏Ä‰∏™Group IDÔºå ÁªÑÂÜÖÂ≠òÂú®Â§ö‰∏™Ê∂àË¥πÂÆû‰æãÂÖ±ÂêåÊ∂àË¥πTopicÊâÄÊúâÁöÑPartitionÔºå<strong>‰∏Ä‰∏™PartitionÂè™ËÉΩË¢´ÂàÜÈÖçÁªôÁªÑÂÜÖ‰∏Ä‰∏™ConsumerÊ∂àË¥π</strong>„ÄÇ</p>
<h6 id="ÂÆûÁé∞‰∏§Â§ßÊ®°Âûã"><a href="#ÂÆûÁé∞‰∏§Â§ßÊ®°Âûã" class="headerlink" title="ÂÆûÁé∞‰∏§Â§ßÊ®°Âûã"></a>ÂÆûÁé∞‰∏§Â§ßÊ®°Âûã</h6><p>Consumer GroupÊòØKafkaÂÆûÁé∞‰∏§‰∏™Ê®°ÂûãÁöÑÊú∫Âà∂</p>
<ul>
<li>Âè™Êúâ‰∏Ä‰∏™ÁªÑËøõË°åÊ∂àË¥πTopicÔºåÈÇ£‰πàÂ∞±ÊòØÈòüÂàóÊ®°Âûã</li>
<li>Â§ö‰∏™ÁªÑÊ∂àË¥πTopicÔºåÈÇ£‰πàÂ∞±ÊòØÂèëÂ∏É/ËÆ¢ÈòÖÊ®°Âûã</li>
</ul>
<h5 id="Standalone-Consumer"><a href="#Standalone-Consumer" class="headerlink" title="Standalone Consumer"></a>Standalone Consumer</h5><p>Áõ∏ÂΩì‰∫éÂè™Êúâ‰∏Ä‰∏™ConsumerÁöÑÊ∂àË¥πÁªÑÔºå‰πüÈúÄË¶ÅGroup IDÊ†áËØÜ</p>
<h5 id="consumer-offsets"><a href="#consumer-offsets" class="headerlink" title="_consumer_offsets"></a>_consumer_offsets</h5><p>_consumer_offsetsÊòØKafkaÂÜÖÈÉ®TopicÔºåÂÆÉÁöÑ‰∏ªË¶Å‰ΩúÁî®Â∞±ÊòØ‰∏∫‰∫Ü‰øùÊåÅConsumerÊ∂àË¥πÁöÑ‰ΩçÁßª‰ø°ÊÅØÔºåÂÆÉÊòØ‰∏Ä‰∏™ÊôÆÈÄöÁöÑTopicÔºåÂèØ‰ª•ÂØπÂÆÉËøõË°åÊìç‰ΩúÔºå‰ΩÜËØ∑‰∏çË¶ÅËøô‰πàÂÅö</p>
<ol>
<li><p>ÂàõÂª∫Êó∂Êú∫</p>
<p>ÂΩì Kafka ÈõÜÁæ§‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ Consumer Á®ãÂ∫èÂêØÂä®Êó∂ÔºåKafka ‰ºöËá™Âä®ÂàõÂª∫‰ΩçÁßª‰∏ªÈ¢òÔºåÈªòËÆ§ÂàÜÂå∫Êï∞ÊòØ50ÔºåÂâØÊú¨Êï∞3„ÄÇÂèØ‰ª•ÈÄöËøá<code>offsets.topic.num.partitions</code>„ÄÅ<code>offsets.topic.replication.factor</code>ÈÖçÁΩÆÔºå‰ΩÜ‰∏çÂª∫ËÆÆ</p>
</li>
<li><p>Ê∂àÊÅØÊ†ºÂºè</p>
<ul>
<li><p>‰ΩçÁßª‰ø°ÊÅØÊ†ºÂºè</p>
<p>‰øùÂ≠òÁöÑÊ∂àÊÅØÊ†ºÂºèÊòØKVÂØπÔºåKeyÁî®&lt;Group ID, Topic, Partition&gt;Êù•Ê†áËØÜÔºå Value‰øùÂ≠ò‰ΩçÁßªÂÄº</p>
</li>
<li><p>‰øùÂ≠ò Consumer Group ‰ø°ÊÅØÁöÑÊ∂àÊÅØ</p>
<p>Áî®‰∫éÊ≥®ÂÜåConsumer Group</p>
</li>
<li><p>tombstoneÊ∂àÊÅØ</p>
<p>Âà†Èô§ Group ËøáÊúü‰ΩçÁßªÁîöËá≥ÊòØÂà†Èô§ Group ÁöÑÊ∂àÊÅØ</p>
</li>
</ul>
</li>
<li><p>GroupÊï∞ÊçÆ‰øùÂ≠òÂú®Âì™‰∏™Âå∫Ôºü</p>
<p>$$partitionId=Math.abs(groupId.hashCode() % offsetsTopicPartitionCount)$$</p>
</li>
<li><p>Compact Á≠ñÁï•</p>
<p>Kafka ‰ΩøÁî®Compact Á≠ñÁï•Êù•Âà†Èô§‰ΩçÁßª‰∏ªÈ¢ò‰∏≠ÁöÑËøáÊúüÊ∂àÊÅØÔºåÈÅøÂÖçËØ•‰∏ªÈ¢òÊó†ÈôêÊúü ËÜ®ËÉÄ„ÄÇËøáÊúüÂÆö‰πâÔºöÂØπ‰∫éÂêå‰∏Ä‰∏™ Key ÁöÑ‰∏§Êù°Ê∂àÊÅØ M1 Âíå M2ÔºåÂ¶ÇÊûú M1 ÁöÑÂèëÈÄÅÊó∂Èó¥Êó©‰∫é M2ÔºåÈÇ£‰πà M1 Â∞±ÊòØËøáÊúüÊ∂àÊÅØ„ÄÇCompact ÁöÑËøáÁ®ãÂ∞±ÊòØÊâ´ÊèèÊó•Âøó ÁöÑÊâÄÊúâÊ∂àÊÅØÔºåÂâîÈô§ÈÇ£‰∫õËøáÊúüÁöÑÊ∂àÊÅØÔºåÁÑ∂ÂêéÊääÂâ©‰∏ãÁöÑÊ∂àÊÅØÊï¥ÁêÜÂú®‰∏ÄËµ∑„ÄÇ</p>
<p>Kafka Êèê‰æõ‰∫Ü‰∏ìÈó®ÁöÑÂêéÂè∞Á∫øÁ®ãÔºà Log CleanerÔºâÂÆöÊúüÂú∞Â∑°Ê£ÄÂæÖ Compact ÁöÑ‰∏ªÈ¢òÔºåÁúãÁúãÊòØÂê¶Â≠òÂú®Êª°Ë∂≥Êù°‰ª∂ÁöÑÂèØÂà† Èô§Êï∞ÊçÆ</p>
</li>
</ol>
<h5 id="CoordinatorÁªÑ‰ª∂"><a href="#CoordinatorÁªÑ‰ª∂" class="headerlink" title="CoordinatorÁªÑ‰ª∂"></a>CoordinatorÁªÑ‰ª∂</h5><p>ÊØè‰∏™BrokerÈÉΩÊúâÂêÑËá™ÁöÑCoordinatorÁªÑ‰ª∂ÔºåÂÆÉÊòØ‰∏ìÈó®‰∏∫Consumer GroupÊúçÂä°ÁöÑÔºåË¥üË¥£‰∏∫ Group ÊâßË°å Rebalance ‰ª•ÂèäÊèê‰æõ‰ΩçÁßªÁÆ°ÁêÜÂíåÁªÑÊàêÂëòÁÆ°ÁêÜ</p>
<p>Â¶Ç‰ΩïÁü•ÈÅìGroupË¢´Âì™‰∏™CoordinatorÁÆ°ÁêÜÔºü</p>
<ol>
<li>Á°ÆÂÆöÁî±ÁöÑÂì™‰∏™_consumer_offsetsÂàÜÂå∫Êù•‰øùÂ≠òËØ• Group Êï∞ÊçÆÔºà_consumer_offsets‰øùÂ≠òÁÆóÊ≥ïÔºâ</li>
<li>ÊâæÂá∫ËØ•ÂàÜÂå∫ Leader ÂâØÊú¨ÊâÄÂú®ÁöÑ BrokerÔºåËØ• Broker Âç≥‰∏∫ÂØπÂ∫îÁöÑ Coordinator„ÄÇ</li>
</ol>
<h5 id="Rebalance"><a href="#Rebalance" class="headerlink" title="Rebalance"></a>Rebalance</h5><p>KafkaÂØπConsumer GroupÈáçÊñ∞ÂàÜÈÖçPartitionÁöÑËøáÁ®ãÁß∞‰∏∫Rebalance„ÄÇRebalance ÂèëÁîüÊó∂ÔºåGroup ‰∏ãÊâÄÊúâÁöÑ Consumer ÂÆû‰æãÈÉΩ‰ºöÂçèË∞ÉÂú®‰∏ÄËµ∑ÂÖ±ÂêåÂèÇ‰∏éÔºåÂú®ÂçèË∞ÉËÄÖÁªÑ‰ª∂ÁöÑÂ∏ÆÂä©‰∏ãÔºåÂÆåÊàêËÆ¢ÈòÖ‰∏ªÈ¢òÂàÜÂå∫ÁöÑÂàÜÈÖç</p>
<ol>
<li><p>‰ΩïÊó∂Ëß¶ÂèëÔºü</p>
<ul>
<li>ÁªÑÊàêÂëòÊï∞ÊîπÂèò</li>
<li>ËÆ¢ÈòÖ‰∏ªÈ¢òÊï∞ÊîπÂèò</li>
<li>ËÆ¢ÈòÖ‰∏ªÈ¢òÂàÜÂå∫Êï∞ÊîπÂèò</li>
</ul>
</li>
<li><p>‰∫ßÁîüÂΩ±Âìç</p>
<p>Âú®RebalanceËøáÁ®ã‰∏≠ÔºåÊâÄÊúâÁöÑConsumerÈÉΩ‰ºöÂÅúÊ≠¢Ê∂àË¥πÔºåÂ¶ÇÊûúÊúâConsumerÊ≠£Âú®Ê∂àË¥πÊ∂àÊÅØÁöÑËØùÔºåÂ∞Ü‰ºöÂØºËá¥Ê∂àÊÅØÈáçÂ§çÊ∂àË¥πÈóÆÈ¢ò</p>
</li>
<li><p>CoordinatorÂ¶Ç‰ΩïÂà§Êñ≠ConsumerÂÆû‰æãÈÄÄÁªÑ</p>
<p>ÂøÉË∑≥Êú∫Âà∂ÔºåÊØè‰∏™ConsumerÈÉΩ‰ºöÂÆöÊúüÁöÑÂêëCoordinatorÂèëÈÄÅÂøÉË∑≥ÔºåÂ¶ÇÊûú‰∏çËÉΩÂèäÊó∂ÂèëÈÄÅÂøÉË∑≥ÔºåÈÇ£‰πàCoordinatorÂ∞±‰ºöËÆ§‰∏∫ËØ•ConsumerÈÄÄÁªÑÔºåËøõËÄåÂºÄÂßãRebalance„ÄÇ</p>
<p>ConsumerÁ´ØÁõ∏ÂÖ≥ÂèÇÊï∞</p>
<ul>
<li><code>heartbeat.interval.ms</code>ÔºöÂøÉË∑≥ËØ∑Ê±ÇÈ¢ëÁéáÂèÇÊï∞</li>
<li><code>max.poll.interval.ms</code>Ôºö ‰∏§Ê¨°Ë∞É Áî® poll ÊñπÊ≥ïÁöÑÊúÄÂ§ßÊó∂Èó¥Èó¥Èöî„ÄÇÂÆÉÁöÑÈªòËÆ§ÂÄºÊòØ 5 ÂàÜÈíü„ÄÇÂú®‰∏§Ê¨°Ë∞ÉÁî®pollÁöÑÈó¥ÈöîÈó¥Ôºå‰∏öÂä°ÈÄªËæëÂ§ÑÁêÜÊó∂Èó¥ËøáÈïøÔºåË∂ÖÂá∫ÈÖçÁΩÆÂÄºÔºåÈÇ£‰πàConsumerÂ∞±‰ºöËá™Âä®ÈÄÄÁªÑ</li>
<li><code>session.timout.ms</code>ÔºöÂ≠òÊ¥ªÊó∂Èó¥Èó¥ÈöîÔºåÈªòËÆ§10s„ÄÇË°®ÊòéÂ¶ÇÊûú10sÂÜÖÊ≤°Êúâ‰ªª‰ΩïÂøÉË∑≥ËØ∑Ê±ÇÔºåCoordinatorÂ∞±Âà§Êñ≠ConsumerÂ∑≤ÁªèÈÄÄÂá∫</li>
</ul>
<p>Êé®ËçêÈÖçÁΩÆÔºö</p>
<p><code>session.timeout.ms = 6s</code></p>
<p><code> heartbeat.interval.ms = 2s</code></p>
<p><code>max.poll.interval.ms</code>ËÆæÁΩÆ‰∏∫‰∏öÂä°ÈÄªËæëÂ§ÑÁêÜÊúÄÈïøÊó∂Èó¥</p>
</li>
</ol>
<h6 id="RebalanceË¶ÅÁÇπ"><a href="#RebalanceË¶ÅÁÇπ" class="headerlink" title="RebalanceË¶ÅÁÇπ"></a>RebalanceË¶ÅÁÇπ</h6><ul>
<li><p>ÈÄöÁü•Êú∫Âà∂</p>
<p>ÂΩìÂèëÁîüRebalanceÊó∂ÔºåCoordinatorÂ∞Ü‚ÄùREBALANCE_IN_PROGRESS‚ÄúÂ∞ÅË£ÖËøõÂøÉË∑≥ËØ∑Ê±ÇÂìçÂ∫îÈáåÈù¢ÔºåConsumer‰πüÂõ†Ê≠§Áü•ÈÅì‰∫ÜÈáçÂπ≥Ë°°È©¨‰∏äÂ∞±Ë¶ÅÂºÄÂßã‰∫Ü</p>
</li>
<li><p>Consumer GroupÁä∂ÊÄÅÊú∫</p>
<p>Kafka‰∏∫Ê∂àË¥πÁªÑÂÆö‰πâ‰∫Ü5ÁßçÁä∂ÊÄÅ</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303190703.png" loading="lazy"></p>
<p>Áä∂ÊÄÅÊú∫ÊµÅËΩ¨Â¶Ç‰∏ã</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303190823.png" loading="lazy"></p>
<p>‰∏Ä‰∏™Ê∂àË¥πËÄÖÁªÑÊúÄÂºÄÂßãÊòØ Empty Áä∂ÊÄÅÔºåÂΩìÈáçÂπ≥Ë°°ËøáÁ®ãÂºÄÂêØÂêéÔºåÂÆÉ‰ºöË¢´ÁΩÆ‰∫é PreparingRebalance Áä∂ÊÄÅÁ≠âÂæÖÊàêÂëòÂä†ÂÖ•Ôºå‰πãÂêéÂèòÊõ¥Âà∞ CompletingRebalance Áä∂ÊÄÅÁ≠âÂæÖÂàÜÈÖçÊñπÊ°àÔºåÊúÄÂêéÊµÅËΩ¨Âà∞ Stable Áä∂ÊÄÅÂÆåÊàêÈáçÂπ≥Ë°°</p>
<p>Â¶ÇÊûúÁªÑÂú®EmptyÁä∂ÊÄÅ‰∏ãÁöÑÂ≠òÂú®ÂæàÈïøÊó∂Èó¥ÔºàÊï¥‰∏™ÁªÑÂÅúÊéâÈïøÊó∂Èó¥‰∏çÂú®Ê∂àË¥πÔºâÔºå‰ΩçÁßªÊï∞ÊçÆÂèØËÉΩ‰ºöË¢´Âà†Èô§</p>
</li>
</ul>
<h6 id="ConsumerÈáçÂπ≥Ë°°Ê≠•È™§"><a href="#ConsumerÈáçÂπ≥Ë°°Ê≠•È™§" class="headerlink" title="ConsumerÈáçÂπ≥Ë°°Ê≠•È™§"></a>ConsumerÈáçÂπ≥Ë°°Ê≠•È™§</h6><ol>
<li><p>Âä†ÂÖ•ÁªÑÔºàJoinGroupËØ∑Ê±ÇÔºâ</p>
<p>ÊØè‰∏™ÁªÑÂëòÈÉΩ‰ºöÂ∞ÜËá™Â∑±ËÆ¢ÈòÖ‰ø°ÊÅØ‰∏äÊä•ÔºåCoordinator‰ºö‰ªéÁªÑÂëò‰∏≠ÈÄâÂá∫Leader ConsumerÔºå‰∏ÄËà¨ÁöÑÁ¨¨‰∏Ä‰∏™ËØ∑Ê±ÇËÄÖ„ÄÇÈÄâ‰∏æÂÆåÂêé‰ºöÂ∞ÜÊâÄÊúâÁöÑËÆ¢ÈòÖ‰ø°ÊÅØÂèëÈÄÅÁöÑLeaders ConsumerÔºåÁî±ÂÖ∂Âà∂ÂÆöÂàÜÈÖç</p>
</li>
<li><p>Á≠âÂæÖLeader ConsumersÂàÜÈÖçÊñπÊ°àÔºàSyncGroupËØ∑Ê±ÇÔºâ</p>
<p>Leaders ConsumerÂÆåÊàêÂàÜÈÖçÊñπÊ°àÂêéÂêëCoordinateÂèëÈÄÅSyncGroupËØ∑Ê±ÇÔºåÂêåÊó∂ÂÖ∂‰ªñÁªÑÂëò‰πü‰ºöÂèëÈÄÅSyncGroupËØ∑Ê±ÇÔºå‰ΩÜÊ≤°ÊúâÂÆûÈôÖÂÜÖÂÆπ„ÄÇÊúÄÂêéÁªü‰∏Ä‰ª•ÂìçÂ∫îÁöÑÊñπÂºèÂàÜÂèëÁªôÊâÄÊúâÁªÑÂëò</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303192421.png" loading="lazy"></p>
<center>JoinGroupËØ∑Ê±Ç</center>

<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303192537.png" loading="lazy"></p>
<center>SyncGroupËØ∑Ê±Ç</center>



<h5 id="‰ΩçÁßªÊèê‰∫§"><a href="#‰ΩçÁßªÊèê‰∫§" class="headerlink" title="‰ΩçÁßªÊèê‰∫§"></a>‰ΩçÁßªÊèê‰∫§</h5><p><strong>ConsumerÈúÄË¶Å‰∏∫ÂàÜÈÖçÁªôÂÆÉÁöÑÊØè‰∏™ÂàÜÂå∫Êèê‰∫§ÂêÑËá™ÁöÑ‰ΩçÁßªÊï∞ÊçÆ</strong>ÔºåÁî®Êù•Ë°®Á§∫Ê∂àË¥πËøõÂ∫¶„ÄÇÊØîÂ¶ÇÊèê‰∫§‰ΩçÁßªËøõÂ∫¶XË°®Á§∫X‰ª•‰∏ãÈÉΩÂ∑≤ÁªèË¢´Ê∂àË¥π</p>
<p>Êèê‰∫§ÊñπÂºèÔºö</p>
<ol>
<li><p>Ëá™Âä®Êèê‰∫§</p>
<p>Ëá™Âä®Êèê‰∫§‰øùËØÅat least oneÔºåËøôÂ∞±ÊÑèÂë≥ÁùÄÂèØËÉΩÂ≠òÂú®Ê∂àÊÅØÈáçÂ§çÊ∂àË¥πÔºåÊØîÂ¶ÇConsumer Ê≠£Âú®Ê∂àË¥πÊó∂ÂÆïÊú∫‰∫ÜÔºå‰∫ßÁîü‰∫ÜRebalanceÔºåÂàÜÈÖçÂÆåÂêéÂÖ∂‰ªñConsumer‰ºö‰ªéÂÆÉÊ∂àË¥πÁöÑÊâÄÊúâPartitionÁöÑÊúÄËøë‰∏ÄÊ¨°Êèê‰∫§‰ΩçÁßªÂ§ÑÂºÄÂßãÊ∂àË¥πÔºå‰ªéËÄåÂØºËá¥ÈáçÂ§çÊ∂àË¥π</p>
<blockquote>
<p>By default, the consumer is configured to auto-commit offsets. Using auto-commit gives you ‚Äúat least once‚Äù delivery: Kafka guarantees that no messages will be missed, but duplicates are possible. Auto-commit basically works as a cron with a period set through the <code>auto.commit.interval.ms</code> configuration property. If the consumer crashes, then after a restart or a rebalance, the position of all partitions owned by the crashed consumer will be reset to the last committed offset. When this happens, the last committed position may be as old as the auto-commit interval itself. Any messages which have arrived since the last commit will have to be read again. <a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/clients/consumer.html#ak-consumer-configuration">consumer doc</a></p>
</blockquote>
<p>ÈÄöËøá<code> enable.auto.commit</code>ËÆæÁΩÆÊòØÂê¶ÂºÄÂêØÔºåÈªòËÆ§ÊòØÂºÄÂêØÁöÑ</p>
<p><code>auto.commit.interval.ms</code>Ë°®Á§∫Ëá™Âä®Êèê‰∫§Èó¥ÈöîÔºåÈªòËÆ§ÂÄº‰∏∫5s</p>
<p>Ëá™Âä®Êèê‰∫§ÈÄªËæëÊòØÂú®pollÊñπÊ≥ïÈáåÈù¢ÊâßË°åÁöÑÔºåÊØèÊ¨°pollÁöÑÊó∂ÂÄôÈÉΩ‰ºöÂà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅËá™Âä®Êèê‰∫§ÔºåÂ§ßÊ¶ÇÈÄªËæëÂ¶Ç‰∏ã</p>
<pre><code>Á¨¨‰∏ÄÊ¨°poll        ËÆæÁΩÆÊèê‰∫§Êó∂Èó¥‰∏∫5sÂêé
    +10s 
Á¨¨‰∫åÊ¨°poll        ‰∏§Ê¨°pollÈó¥Èöî‰∏∫10sÔºåÊØî5sÂ§ßÂ∞±Ëá™Âä®Êèê‰∫§ÔºåÁÑ∂ÂêéËÆæÁΩÆ‰∏ãÊ¨°Êèê‰∫§Êó∂Èó¥‰∏∫15s</code></pre>
</li>
<li><p>ÊâãÂä®Êèê‰∫§</p>
<p>Â∞Ü<code>enable.auto.commit</code>ËÆæÁΩÆ‰∏∫falseÂç≥ÂèØÔºåKafkaÊèê‰æõÂêåÊ≠•ÂíåÂºÇÊ≠•Êèê‰∫§‰∏§ÁßçÊñπÂºè</p>
<ul>
<li><p>ÂêåÊ≠•Êèê‰∫§</p>
<p>‰ΩøÁî®KafkaConsumer#commitSyncÊñπÊ≥ïÔºåÊèê‰æõÈáçËØïÊú∫Âà∂ÔºåÂêåÊ≠•Êèê‰∫§‰ºöÂΩ±ÂìçTPS</p>
</li>
<li><p>ÂºÇÊ≠•Êèê‰∫§</p>
<p>‰ΩøÁî® KafkaConsumer#commitAsync()ÊñπÊ≥ïÔºåÊ≤°ÊúâÈáçËØïÊú∫Âà∂ÔºåÂºÇÊ≠•ÊñπÂºèÈáçËØïÊú∫Âà∂ÊòØÊ≤°ÊúâÊÑè‰πâÁöÑ</p>
<p>ÂºÇÊ≠•Êèê‰∫§ÂèØËÉΩ‰ºöÂØºËá¥Ê∂àÊÅØ‰∏¢Â§±ÔºåKafkaÊèê‰æõÂõûË∞ÉÂáΩÊï∞ÔºåÂèØ‰ª•ÈÄöËøáÂõûË∞ÉÂáΩÊï∞Êó∂ËøõË°åÂ§±Ë¥•ÈÄªËæëÂ§ÑÁêÜ</p>
</li>
</ul>
<p>Â∞ÜÂêåÊ≠•Êèê‰∫§ÂíåÂºÇÊ≠•Êèê‰∫§ÁªìÂêà</p>
<pre><code class="java">try&#123;
    while (true) &#123;
        ConsumerRecords&lt;String, String&gt; records = 
        consumer.poll(Duration.ofSeconds(1));
         process(records); // Â§ÑÁêÜÊ∂àÊÅØ
         commitAysnc(); // ‰ΩøÁî®ÂºÇÊ≠•Êèê‰∫§ËßÑÈÅøÈòªÂ°û
     &#125;
&#125; catch (Exception e) &#123;
     handle(e); // Â§ÑÁêÜÂºÇÂ∏∏
&#125; finally &#123;
     try &#123;
         consumer.commitSync(); // ÊúÄÂêé‰∏ÄÊ¨°Êèê‰∫§‰ΩøÁî®ÂêåÊ≠•ÈòªÂ°ûÂºèÊèê‰∫§
    &#125; finally &#123;
         consumer.close();
    &#125;
&#125;</code></pre>
<p>‰πüÂèØ‰ª•‰ΩøÁî®<code>commitSync(final Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets)</code>Âèä<code>commitAsync(final Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets, OffsetCommitCallback callback)</code>ËøõË°åÂ∞èÊâπÈáèÊèê‰∫§ÔºåÊØîÂ¶ÇÊØèÊ∂àË¥π‰∏ÄÁôæÊù°Êèê‰∫§‰∏ÄÊ¨°</p>
<pre><code class="java">
private Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets = new HashMap&lt;&gt;();
int count = 0;
‚Ä¶‚Ä¶
while (true) &#123;
     ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofSeconds(1));
     for (ConsumerRecord&lt;String, String&gt; record: records) &#123;
         process(record); // Â§ÑÁêÜÊ∂àÊÅØ
         offsets.put(new TopicPartition(record.topic(), record.partition()),
         new OffsetAndMetadata(record.offset() + 1)Ôºõ
         ifÔºàcount % 100 == 0Ôºâ
             consumer.commitAsync(offsets, null); // ÂõûË∞ÉÂ§ÑÁêÜÈÄªËæëÊòØ n
         count++;
    &#125;
&#125;</code></pre>
</li>
</ol>
<p>Ëá™Âä®Êèê‰∫§ÂíåÊâãÂä®Êèê‰∫§ÈÉΩÊó†Ê≥ïÈÅøÂÖçÊ∂àÊÅØÈáçÂ§çÊ∂àÊÅØÈóÆÈ¢òÔºåÈúÄË¶ÅÂú®‰∏öÂä°‰∏äÂÅöÂéªÈáç</p>
<h5 id="ConsumerÂª∫Á´ãTCPËøûÊé•ÁßçÁ±ª"><a href="#ConsumerÂª∫Á´ãTCPËøûÊé•ÁßçÁ±ª" class="headerlink" title="ConsumerÂª∫Á´ãTCPËøûÊé•ÁßçÁ±ª"></a>ConsumerÂª∫Á´ãTCPËøûÊé•ÁßçÁ±ª</h5><p>Êúâ3Á±ªTCPËøûÊé•</p>
<ol>
<li><p>ÂèëËµ∑ FindCoordinator ËØ∑Ê±ÇÊó∂ÔºàÁ¨¨‰∏ÄÁ±ªÔºâ</p>
<p>ÂàõÂª∫TCPËøûÊé•ÔºåÂèëÈÄÅFindCoordinatorËØ∑Ê±ÇÂà∞<code>bootstrap.servers</code>ÁöÑ‰ªªÊÑèÊúçÂä°Âô®ÔºåÂæóÂà∞ÁÆ°ÁêÜÂÆÉÁöÑBrokerÂÖÉÊï∞ÊçÆ</p>
</li>
<li><p>ËøûÊé•CoordinatorÔºàÁ¨¨‰∫åÁ±ªÔºâ</p>
<p>ÂàõÂª∫‰∏éCoordinatorÁöÑTCPËøûÊé•ÔºåËøôÊ†∑ÊâçËÉΩÂºÄÂêØÁªÑÂçèË∞ÉÊìç‰Ωú</p>
</li>
<li><p>Ê∂àË¥πÊ∂àÊÅØÊó∂ÔºàÁ¨¨‰∏âÁ±ªÔºâ</p>
<p>Consumer‰∏∫ÊØè‰∏™Ë¶ÅÊ∂àË¥πÁöÑÂàÜÂå∫ÂàõÂª∫‰∫éËØ•ÂàÜÂå∫È¢ÜÂØºËÄÖÂâØÊú¨ÊâÄÂú®ÁöÑBrokerËøûÊé•ÁöÑTCP</p>
</li>
</ol>
<p>ÂΩìÁ¨¨‰∏âÁ±ªËøûÊé•Âª∫Á´ãÊó∂ÔºåConsumer‰ºökillÊéâÁ¨¨‰∏ÄÁ±ªTCPËøûÊé•</p>
<h5 id="Ê∂àË¥πËøõÂ∫¶ÁõëÊéß"><a href="#Ê∂àË¥πËøõÂ∫¶ÁõëÊéß" class="headerlink" title="Ê∂àË¥πËøõÂ∫¶ÁõëÊéß"></a>Ê∂àË¥πËøõÂ∫¶ÁõëÊéß</h5><ul>
<li>LagÔºöË°®Á§∫Ê∂àË¥πÊ∂àÊÅØËêΩÂêéÁîü‰∫ßÊ∂àÊÅØÁ®ãÂ∫¶ÔºåÊØîÂ¶Ç‰∫ßÁîü‰∫Ü100‰∏áÊù°Ê∂àÊÅØÔºåÂΩìÂâçÊ∂àË¥π‰∫Ü80‰∏áÊù°ÔºåÈÇ£‰πàÊ∂àÊÅØÊªûÂêé‰∫Ü20‰∏áÊù°ÔºåÂç≥Lag=20w</li>
<li>LeadÔºöË°®Á§∫ÊúÄÊñ∞Ê∂àË¥πÊ∂àÊÅØÁöÑ‰ΩçÁßªÂíåÂàÜÂå∫Á¨¨‰∏ÄÊù°‰ΩçÁßªÁöÑÂ∑ÆÂÄºÔºåÊØîÂ¶ÇÂΩìÂâçÊ∂àË¥π‰ΩçÁßª‰∏∫5ÔºåÁ¨¨‰∏ÄÊù°‰ΩçÁßª‰∏∫0ÔºåÈÇ£‰πàLead=5</li>
</ul>
<p>‰ΩøÁî®JMXÁõëÊéß</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303160430.png" alt="image-20230303160423390" loading="lazy"></p>
<h4 id="ÂâØÊú¨Êú∫Âà∂"><a href="#ÂâØÊú¨Êú∫Âà∂" class="headerlink" title="ÂâØÊú¨Êú∫Âà∂"></a>ÂâØÊú¨Êú∫Âà∂</h4><p> KafkaÈááÁî®‰∫ÜÂü∫‰∫éÈ¢ÜÂØºËÄÖÁöÑÔºàLeader-basedÔºâÁöÑÂâØÊú¨Êú∫Âà∂„ÄÇ</p>
<ol>
<li>ÂâØÊú¨ÂàÜ‰∏∫LeaderÂíåFollowerÂâØÊú¨ÔºåFollower‰ºöËá™Âä®ËøΩÈöèLeader</li>
<li>Âè™ÊúâLeaderÂØπÂ§ñÊèê‰æõÊúçÂä°ÔºåFollower‰ªéLeaderÂºÇÊ≠•ÊãâÂèñÊ∂àÊÅØ</li>
<li>Â¶ÇÊûúLeaderÊåÇ‰∫ÜÔºåKafka‰ºöËøõË°åÈáçÊñ∞ÈÄâ‰∏æ</li>
</ol>
<h5 id="In-sync-ReplicasÔºàISRÔºâ"><a href="#In-sync-ReplicasÔºàISRÔºâ" class="headerlink" title="In-sync ReplicasÔºàISRÔºâ"></a>In-sync ReplicasÔºàISRÔºâ</h5><p>‰∏éLeader‰øùÊåÅÂêåÊ≠•ÁöÑÂâØÊú¨Áß∞‰∏∫ISRÔºåÊòØÂê¶‰øùÊåÅÂêåÊ≠•ÁöÑÊ†áÂáÜÂ∞±ÊòØBroker Á´ØÂèÇÊï∞ <code>replica.lag.time.max.ms </code>ÂèÇÊï∞ÂÄºÔºåÈªòËÆ§10s„ÄÇÂÆÉË°®Á§∫ÁöÑÊòØFollowerËÉΩÂ§üËêΩÂêéLeaderÁöÑÊúÄÈïøÊó∂Èó¥</p>
<p>KafkaÂú®ÂêØÂä®Êó∂‰ºöÂºÄÂêØ‰∏§‰∏™‰ªªÂä°Ôºå‰∏ÄÊòØÂÆöÊúüÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÁº©ÂáèÊàñÊâ©Â§ßISRÈõÜÂêàÔºåÂë®ÊúüÊòØ<code>ÊòØreplica.lag.time.max.ms</code>‰∏ÄÂçäÔºõ‰∫åÊòØÂÆöÊúüÊ£ÄÊü•isrChangeSetÔºàÁºìÂ≠òISRÂèòÊõ¥ËÆ∞ÂΩïÈõÜÂêàÔºâÔºåÂ¶ÇÊûúSetÊúâÂèòÊõ¥ËÆ∞ÂΩïÔºåÈÇ£‰πà‰ºöÂú®zk‰∏≠ÊåÅ‰πÖÂåñ‰∏Ä‰∏™ËäÇÁÇπ „ÄÇcontrollerËäÇÁÇπÊ≥®ÂÜåÁöÑwatcherËÉΩÊÑüÁü•Âà∞ISRÁöÑÂèòÂåñÁÑ∂ÂêéÂêëÂÆÉÊâÄÁÆ°ÁêÜÁöÑBrokerËäÇÁÇπÂèëÈÄÅÊõ¥Êñ∞ÂÖÉÊï∞ÊçÆËØ∑Ê±ÇÔºåÊúÄÂêéÂà†Èô§Â§ÑÁêÜËøáÁöÑËäÇÁÇπ</p>
<ul>
<li><p>Ë∏¢Âá∫ISR</p>
<p>Â¶ÇÊûúFollowerÂú®Ë∂ÖÂá∫‰∫Ü<code>replica.lag.time.max.ms</code>Êó∂Èó¥ÂêéËøòÂá∫‰∫éËêΩÂêéÁä∂ÊÄÅÔºåÈÇ£Â∞±‰ºöË¢´Ë∏¢Âá∫ISR„ÄÇ</p>
</li>
<li><p>ËøõÂÖ•ISR</p>
<p>ÂΩìÊ£ÄÊü•Âà∞FollowerÁöÑHigh WatermarkËøΩËµ∂‰∏äLeaderÊó∂Â∞±Êâ©ÂÖÖISR</p>
</li>
</ul>
<h5 id="Unclean-Leader-Election"><a href="#Unclean-Leader-Election" class="headerlink" title="Unclean Leader Election"></a>Unclean Leader Election</h5><p>Unclean Leader ElectionÊåáÁöÑÊòØÂΩìISR‰∏∫Á©∫ÔºàLeader‰πü‰∏çÂú®‰∫ÜÔºâÊó∂ÔºåÊòØÂê¶ÂÖÅËÆ∏KafkaÂú®ÈùûÂêåÊ≠•ÂâØÊú¨‰∏≠ÈÄâ‰∏æÊñ∞ÁöÑLeaderÔºåÂ¶ÇÊûú‰∏çÂÖÅËÆ∏ÔºåÈÇ£‰πàÂàÜÂå∫Â∞±Â§±Êïà‰∫Ü„ÄÇ</p>
<p>ÈÄöËøáBroker Á´ØÂèÇÊï∞ <code>unclean.leader.election.enable</code>ÊéßÂà∂ÊòØÂê¶ÂºÄÂêØ</p>
<p>ÂºÄÂêØÈÄâÈ°πÂèØËÉΩ‰ºöÈÄ†ÊàêÊï∞ÊçÆ‰∏¢Â§´ÔºåÂ•ΩÂ§ÑÂú®‰∫éÊèêÈ´ò‰∫ÜÂèØÁî®ÊÄß</p>
<h5 id="High-Watermark-HW"><a href="#High-Watermark-HW" class="headerlink" title="High Watermark(HW)"></a>High Watermark(HW)</h5><p>KafkaÁî®High WatermarkÊù•Ë°®ÂæÅÊ∂àÊÅØ‰ΩçÁßªÔºåÊúâ‰ª•‰∏ã‰ΩúÁî®</p>
<ul>
<li>ÂÆö‰πâÊ∂àÊÅØÂèØËßÅÊÄßÔºåÂç≥ÂàÜÂå∫Âì™‰∫õÊ∂àÊÅØÂèØË¢´Ê∂àË¥π</li>
<li>Â∏ÆÂä©KafkaÂÆåÊàêÂâØÊú¨ÂêåÊ≠•</li>
</ul>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230305165243.png" loading="lazy"></p>
<p>Âêå‰∏Ä‰∏™ÂâØÊú¨ÂØπË±°ÔºåÂÖ∂È´ò Ê∞¥‰ΩçÂÄº‰∏ç‰ºöÂ§ß‰∫é LEOÔºàLog End Offset) ÂÄº</p>
<h6 id="Êõ¥Êñ∞Êú∫Âà∂"><a href="#Êõ¥Êñ∞Êú∫Âà∂" class="headerlink" title="Êõ¥Êñ∞Êú∫Âà∂"></a>Êõ¥Êñ∞Êú∫Âà∂</h6><p><img src="https://raw.githubusercontent.com/soda1/img/main/20230305165811.png" loading="lazy"></p>
<p>ÊØè‰∏™ÂâØÊú¨ÈÉΩ‰ºö‰øùÂ≠òHWÂíåLEO‰∏§‰∏™Â±ûÊÄßÔºåËÄåLeaderÊâÄÂú®ÁöÑBroker‰πü‰ºö‰øùÂ≠òÊâÄÊúâFollowerÁöÑÂâØÊú¨ÔºåÁî®‰∫éÂ∏ÆÂä©LeaderÁ°ÆÂÆöÂÖ∂HW„ÄÇ</p>
<p><strong>Leader‰∏ãÊõ¥Êñ∞ÈÄªËæë</strong></p>
<p>Â§ÑÁêÜProducerÊ∂àÊÅØ</p>
<ol>
<li>Ê∂àÊÅØÂÜôÂÖ•Á£ÅÁõò</li>
<li>Êõ¥Êñ∞ÂàÜÂå∫HW<ol>
<li>Ëé∑ÂèñLeaderÊâÄÂú®Broker‰øùÂ≠òÁöÑFollowersÁöÑLEOÂÄº{LEO-1ÔºåLEO-2‚Ä¶}</li>
<li>Êõ¥Êñ∞HW=min(leader-LEO, LEO-1, LEO-2‚Ä¶..)</li>
</ol>
</li>
</ol>
<p>Â§ÑÁêÜFollowerÊãâÂèñÊ∂àÊÅØ</p>
<ol>
<li>Ê†πÊçÆFollowerÂèëÈÄÅÊù•ÁöÑLEOËØªÂèñÊ∂àÊÅØÊï∞ÊçÆ</li>
<li>Â∞ÜFollowerÂèëÈÄÅÊù•ÁöÑLEOÊõ¥Êñ∞Âà∞Broker‰øùÂ≠òÁöÑÂØπÂ∫îÂâØÊú¨‰∏≠</li>
<li>Êõ¥Êñ∞ÂàÜÂå∫HWÔºàÂêå‰∏äÔºâ</li>
</ol>
<p><strong>Follower‰∏ãÊõ¥Êñ∞ÈÄªËæë</strong></p>
<p>‰ªéLeaderÂ§ÑÊãâÂèñÊ∂àÊÅØÔºö</p>
<ol>
<li>Â∞ÜÊ∂àÊÅØÂÜôÂÖ•Á£ÅÁõò</li>
<li>Êõ¥Êñ∞LEO</li>
<li>Êõ¥Êñ∞HW<ol>
<li>Ëé∑ÂèñLeaderÂèëÈÄÅÊù•ÁöÑleader-LEO</li>
<li>Ëé∑ÂèñÊõ¥Êñ∞ËøáÁöÑcurrentLEO</li>
<li>Êõ¥Êñ∞È´òÊ∞¥‰Ωç‰∏∫min(leader-LEO, currentLEO)</li>
</ol>
</li>
</ol>
<p><strong>Êõ¥Êñ∞Â≠òÂú®ÈóÆÈ¢ò</strong></p>
<p>HWÁöÑÊõ¥Êñ∞ÈÄöÂ∏∏ÈúÄË¶ÅÈ¢ùÂ§ñ‰∏ÄËΩÆÁöÑÊãâÂèñËØ∑Ê±ÇÊâçËÉΩÂÆåÊàêÔºåÂÆπÊòìÂºïÂèë‰ª•‰∏ãÈóÆÈ¢ò</p>
<ul>
<li><p>Â§á‰ªΩÊï∞ÊçÆ‰∏¢Â§±</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230305172705.png" loading="lazy"></p>
<p>Â¶ÇÂõæÊâÄÁ§∫ÔºåÂΩìAÊõ¥Êñ∞ÂÆåHWÂêéÔºåBËøòÊú™Êù•ÂæóÂèäÊõ¥Êñ∞Â∞±ÂÆïÊú∫‰∫ÜÔºåÈáçÂêØÂêéHWËøòÊòØ‰∏∫1ÔºåÊ≠§Êó∂ÂêëAÂèëÈÄÅFetchËØ∑Ê±ÇÔºåÂ¶ÇÊûúAÊÅ∞Â•ΩÂèàÂÆïÊú∫‰∫ÜÔºåÈÇ£‰πàBÂ∞±‰ºöÊàê‰∏∫LeaderÔºåÂêéÈù¢AÈáçÂêØÂêéÂêëBÂèëÈÄÅFetchËØ∑Ê±ÇÔºåHWÂ∞ÜÊõ¥Êñ∞‰∏∫1Ôºå‰ªéËÄå‰∏¢Â§±Êï∞ÊçÆ</p>
</li>
<li><p>Â§á‰ªΩÊï∞ÊçÆ‰∏ç‰∏ÄËá¥</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230305235446.png" loading="lazy"></p>
<p>Â¶ÇÂõæÊâÄÁ§∫ÔºåÂΩìAÁöÑHW=2 ÂíåBÁöÑHW=1Êó∂ÂêåÊó∂ÂèëÁîü‰∫ÜÂÆïÊú∫ÔºåBÈáçÂêØÂêéÊàê‰∏∫‰∫ÜLeaderÔºåÊ≠§Êó∂ProducerÂèëÈÄÅ‰∫ÜÊ∂àÊÅØÁªôBÔºåBÂ∞±‰ºöË¶ÜÁõñÊ∂àÊÅØ2‰∏îHW‰πü‰ºöÊõ¥Êñ∞‰∏∫2ÔºåÂêéÈù¢AÈáçÂêØÂõûÊù•‰ºöÊâßË°åÊó•ÂøóÊà™Êñ≠Ôºå‰ΩÜÂèëÁé∞ÂàÜÂå∫ÁöÑHWÂíåËá™Â∑±ÁöÑHWÈÉΩÊòØ2ÔºåÊïÖ‰∏ç‰Ωú‰ªª‰ΩïË∞ÉÊï¥Ôºå‰ªéËÄåÂºïËµ∑Êï∞ÊçÆ‰∏ç‰∏ÄËá¥</p>
<p><strong>leader epoch</strong></p>
<p>Kafka‰ªé0.11ÂºïÂÖ•leader epochÔºå‰ªéËÄåËßÑÈÅø‰ª•‰∏äÈóÆÈ¢ò„ÄÇleader epochÂÆûÈôÖÊòØ‰∏ÄÂØπÂÄºÔºàepochÔºå offsetÔºâÔºåepochË°®Á§∫ÁâàÊú¨Âè∑Ôºå‰ªé0ÂºÄÂßãÔºåÊØèÂΩìleaderËßíËâ≤ÂèëÁîüÂèòÊõ¥Â∞±+1ÔºåoffsetË°®Á§∫ÂÜôÂÖ•ËØ•epochÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØ‰ΩçÁßª„ÄÇ</p>
<p>Kafka Broker ‰ºöÂú®ÂÜÖÂ≠ò‰∏≠‰∏∫ÊØè‰∏™ÂàÜÂå∫ÈÉΩÁºìÂ≠ò  epoch Êï∞ÊçÆÔºåÂêåÊó∂ÂÆÉËøòÂ∞ÜËøô‰∫õ ‰ø°ÊÅØÊåÅ‰πÖÂåñÂà∞‰∏Ä‰∏™ checkpoint Êñá‰ª∂‰∏≠„ÄÇÂ¶ÇÊûúLeader ÊòØÈ¶ñÊ¨°ÂÜôÂÖ•Ê∂àÊÅØÔºåÈÇ£‰πàBroker‰ºöÂêëÁºìÂ≠ò‰∏≠Â¢ûÂä†‰∏Ä‰∏™ epoch Êù°ÁõÆÔºåÂê¶ÂàôÂ∞±‰∏çÂÅöÊõ¥Êñ∞„ÄÇ</p>
<p>Ëß£ÂÜ≥Êï∞ÊçÆ‰∏¢Â§±</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230306010801.png" loading="lazy"></p>
<p>ÂâØÊú¨BÈáçÂêØÂêéÂêëAÂèëÈÄÅLeaderEpochRequestËé∑ÂèñAÁöÑLEOÂÄºÔºåÂèëÁé∞AÁöÑLEO‰∏çÊØîËá™Â∑±ÁöÑÂ∞èÔºå‰∏îepoch‰∏≠ÁöÑoffset‰πüÊ≤°ÊúâÊØî2Â§ßÔºåÂõ†Ê≠§Êó†ÈúÄÊâßË°å‰ªª‰ΩïÊó•ÂøóÊà™Êñ≠</p>
<p>ÂΩìBÊàê‰∏∫LeaderÊó∂,[epoch = 1, offset = 3],AÈáçÂêØÂêé‰ºöÂêëBÂèëÈÄÅLeaderEpochRequestÂéªËé∑ÂèñLeaderÁöÑLEOÂÄºÔºåÂèëÁé∞ÂÖ∂LEOÊØîBÁöÑÂ∞è‰∏îepoch‰∏≠ÁöÑoffset‰πüÊ≤°ÊúâÊØî3Â§ßÔºåÂõ†Ê≠§‰πüÊó†ÈúÄÊà™Êñ≠</p>
<p>Ê≥®ÊÑèÂè™ÊúâFollowerÊâç‰ºöÊâßË°åÊó•ÂøóÊà™Êñ≠ÔºåLeaderÊòØ‰∏ç‰ºöÊâßË°åÊó•ÂøóÊà™Êñ≠ÁöÑ</p>
</li>
</ul>
<h4 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h4><p><img src="https://raw.githubusercontent.com/soda1/img/main/20230306151424.png" loading="lazy"></p>
<p>todoÔºöÂ§ñÁΩëÊöÇÊú™ÊâæÂà∞Áõ∏ÂÖ≥ËµÑÊñô</p>
<h5 id="BrokerÁΩëÁªúÊ®°Âûã"><a href="#BrokerÁΩëÁªúÊ®°Âûã" class="headerlink" title="BrokerÁΩëÁªúÊ®°Âûã"></a>BrokerÁΩëÁªúÊ®°Âûã</h5><p>BrokerÁΩëÁªúÂ±ÇÈááÁî®‰∫ÜReactorÊ®°ÂºèÔºåÊúâ‰∏™Ê†∏ÂøÉÁªÑ‰ª∂SocketServerÔºåÁ∫øÁ®ãÊ®°ÂûãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>‰∏Ä‰∏™AcceptorÁ∫øÁ®ãÊé•Êî∂ËØ∑Ê±Ç</li>
<li>N‰∏™ProcessorÁ∫øÁ®ã,ÊØè‰∏™ProcessorÈÉΩÊúâËá™Â∑±ÁöÑselector,‰ªéÊØè‰∏™ËøûÊé•‰∏≠ËØªÂèñËØ∑Ê±Ç</li>
<li>M‰∏™HandlerÁ∫øÁ®ãÂ§ÑÁêÜËØ∑Ê±Ç,Âπ∂Â∞Ü‰∫ßÁîüÁöÑËØ∑Ê±ÇËøîÂõûÁªôProcessorÁ∫øÁ®ãÁî®‰∫éÂÜôÂõûÂÆ¢Êà∑Á´Ø</li>
</ul>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303184103.png" loading="lazy"></p>
<h4 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h4><p>ÊéßÂà∂Âô®ÁªÑ‰ª∂ÔºàControllerÔºâÊòØ Apache Kafka ÁöÑÊ†∏ÂøÉÁªÑ‰ª∂„ÄÇÂÆÉÁöÑ‰∏ªË¶Å‰ΩúÁî®ÊòØÂú® Apache ZooKeeper ÁöÑÂ∏ÆÂä©‰∏ãÁÆ°ÁêÜÂíåÂçèË∞ÉÊï¥‰∏™ Kafka ÈõÜÁæ§„ÄÇKafkaÈõÜÁæ§ÈÄöËøáÈÄâ‰∏æÈÄâÂá∫Controller„ÄÇJMXÊåáÊ†á‰∏∫<code>activeController</code></p>
<h5 id="‰ΩúÁî®"><a href="#‰ΩúÁî®" class="headerlink" title="‰ΩúÁî®"></a>‰ΩúÁî®</h5><ol>
<li><p>‰∏ªÈ¢òÁÆ°ÁêÜÔºàÂàõÂª∫„ÄÅÂà†Èô§„ÄÅÂ¢ûÂä†ÂàÜÂå∫Ôºâ</p>
</li>
<li><p>ÂàÜÂå∫ÈáçÂàÜÈÖç</p>
</li>
<li><p>.Preferred È¢ÜÂØºËÄÖÈÄâ‰∏æ</p>
<p>PreferredÈÄâ‰∏æÊòØKafka‰∏∫‰∫ÜÈÅøÂÖçÈÉ®ÂàÜBrokerË¥üËΩΩËøáÈáçËÄåÊèê‰æõÁöÑ‰∏ÄÁßçÊç¢LeaderÊñπÊ°à</p>
</li>
<li><p>ÈõÜÁæ§ÊàêÂëòÁÆ°ÁêÜÔºàÊñ∞Â¢û Broker„ÄÅBroker ‰∏ªÂä®ÂÖ≥Èó≠„ÄÅBroker ÂÆïÊú∫Ôºâ</p>
</li>
<li><p>Êï∞ÊçÆÊúçÂä°ÔºàÈõÜÁæ§ÂÖÉÊï∞ÊçÆ‰ø°ÊÅØÔºâ</p>
<p>Controller‰ºöÊúâÊï¥‰∏™ÈõÜÁæ§ÊúÄÂÆåÊï¥ÁöÑÂÖÉÊï∞ÊçÆ‰ø°ÊÅØÔºåZookeeper‰πü‰ºö‰øùÂ≠ò‰∏Ä‰ªΩÔºåControllerÁöÑÂàùÂßãÂåñÂÖÉÊï∞ÊçÆ‰ø°ÊÅØÁî±ZookeeperÊèê‰æõ</p>
</li>
</ol>
<h5 id="Â¶Ç‰ΩïÈÄâ‰∏æ"><a href="#Â¶Ç‰ΩïÈÄâ‰∏æ" class="headerlink" title="Â¶Ç‰ΩïÈÄâ‰∏æ"></a>Â¶Ç‰ΩïÈÄâ‰∏æ</h5><p>ÂΩìBrokerÂêØÂä®Êó∂Ôºå‰ºöÂ∞ùËØïÂú®Zookeeper‰∏≠/controllerËäÇÁÇπÔºåÁ¨¨‰∏Ä‰∏™ÂàõÂª∫ÊàêÂäüÁöÑBroker‰ºöË¢´ÈÄâ‰∏æ‰∏∫Controller</p>
<h5 id="Â§±ÊïàÂ§ÑÁêÜ"><a href="#Â§±ÊïàÂ§ÑÁêÜ" class="headerlink" title="Â§±ÊïàÂ§ÑÁêÜ"></a>Â§±ÊïàÂ§ÑÁêÜ</h5><p>ÂΩìControllerÊâÄÂú®ÁöÑBrokerÂá∫Áé∞ÂºÇÂ∏∏ÈÄÄÂá∫‰∫ÜÈõÜÁæ§ÔºåZookeeperÈÄöËøáWatchÊú∫Âà∂ÊÑüÂ∫îÂπ∂Â∞Ü/controllerËäÇÁÇπÂà†Èô§Ôºå‰πãÂêéÂ≠òÊ¥ªÁöÑBroker‰ºöÂºÄÂßãËøõË°åÈÄâ‰∏æÔºåÈÄâ‰∏æÊàêÂäüÁöÑBroker‰ºö‰ªéZookeeper‰∏≠ËØªÂèñÂÖÉÊï∞ÊçÆ‰ø°ÊÅØÔºåËøõË°åÂàùÂßãÂåñ„ÄÇ</p>
<h5 id="ÂÜÖÈÉ®ËÆæËÆ°ÁªìÊûÑ"><a href="#ÂÜÖÈÉ®ËÆæËÆ°ÁªìÊûÑ" class="headerlink" title="ÂÜÖÈÉ®ËÆæËÆ°ÁªìÊûÑ"></a>ÂÜÖÈÉ®ËÆæËÆ°ÁªìÊûÑ</h5><p><img src="https://raw.githubusercontent.com/soda1/img/main/20230304145246.png" loading="lazy"></p>
<h4 id="Âä®ÊÄÅBrokerÂèÇÊï∞"><a href="#Âä®ÊÄÅBrokerÂèÇÊï∞" class="headerlink" title="Âä®ÊÄÅBrokerÂèÇÊï∞"></a>Âä®ÊÄÅBrokerÂèÇÊï∞</h4><p>‰ªé1.1ÁâàÊú¨ÂºÄÂßãÔºå Brokers ConfigsÂ¢ûÂä†Update ModelÂàóÔºåÊúâ‰∏âÁ±ªÂÄº</p>
<ul>
<li>read-olnyÔºöË°®Á§∫‰øÆÊîπÂè™ËÉΩÈáçÂêØBrokerÂêéÊâçËÉΩÁîüÊïà</li>
<li>per-broker: Â±û‰∫éÂä®ÊÄÅÂèÇÊï∞Ôºå‰øÆÊîπÂêéÂè™Âú®ÂØπÂ∫îBroker‰∏äÁîüÊïà</li>
<li>cluster-wideÔºöÂ±û‰∫éÂä®ÊÄÅÂèÇÊï∞Ôºå‰øÆÊîπÂêéÊï¥‰∏™ÈõÜÁæ§ÁîüÊïà</li>
</ul>
<p><del>‰ºòÂÖàÁ∫ßÂà´Ôºö per-broker &gt; cluster-wide &gt; read-only&gt; KafkaÈªòËÆ§ÂÄº</del></p>
<p><strong>‰ΩøÁî®Âú∫ÊôØ</strong></p>
<ul>
<li>Âä®ÊÄÅË∞ÉÊï¥ Broker Á´ØÂêÑÁßçÁ∫øÁ®ãÊ±†Â§ßÂ∞èÔºåÂÆûÊó∂Â∫îÂØπÁ™ÅÂèëÊµÅÈáè</li>
<li> Âä®ÊÄÅË∞ÉÊï¥ Broker Á´ØËøûÊé•‰ø°ÊÅØÊàñÂÆâÂÖ®ÈÖçÁΩÆ‰ø°ÊÅØ</li>
<li> Âä®ÊÄÅÊõ¥Êñ∞ SSL Keystore ÊúâÊïàÊúü</li>
<li> Âä®ÊÄÅË∞ÉÊï¥ Broker Á´Ø Compact Êìç‰ΩúÊÄßËÉΩ</li>
<li> ÂÆûÊó∂ÂèòÊõ¥ JMX ÊåáÊ†áÊî∂ÈõÜÂô® (JMX Metrics Reporter)</li>
</ul>
<p><strong>Â¶Ç‰ΩïÈÖçÁΩÆ</strong></p>
<p>‰ΩøÁî®kafka-config.sh</p>
<h4 id="ÈáçËÆæÊ∂àË¥πÁªÑ‰ΩçÁßª"><a href="#ÈáçËÆæÊ∂àË¥πÁªÑ‰ΩçÁßª" class="headerlink" title="ÈáçËÆæÊ∂àË¥πÁªÑ‰ΩçÁßª"></a>ÈáçËÆæÊ∂àË¥πÁªÑ‰ΩçÁßª</h4><p><strong>Á≠ñÁï•</strong></p>
<ul>
<li>EarliestÔºöÊää‰ΩçÁßªË∞ÉÊï¥Âà∞ÂΩìÂâçÊúÄÊó©‰ΩçÁßªÂ§Ñ</li>
<li>LatestÔºöÊää‰ΩçÁßªË∞ÉÊï¥Âà∞ÂΩìÂâçÊúÄÊñ∞‰ΩçÁßªÂ§Ñ</li>
<li>CurrentÔºöÊää‰ΩçÁßªË∞ÉÊï¥Âà∞ÂΩìÂâçÊúÄÊñ∞Êèê‰∫§‰ΩçÁßªÂ§Ñ</li>
<li>Specified-OffsetÔºöÊää‰ΩçÁßªË∞ÉÊï¥Âà∞ÊåáÂÆö‰ΩçÁßªÂ§Ñ</li>
<li>Shift-By-NÔºöÊää‰ΩçÁßªË∞ÉÊï¥Âà∞ÂΩìÂâç‰ΩçÁßª +NÂ§ÑÔºàNÂèØ‰∏∫Ë¥üÂÄºÔºâ</li>
<li>DateTimeÔºöÊää‰ΩçÁßªË∞ÉÊï¥Âà∞Â§ß‰∫éÁªôÂÆöÊó∂Èó¥ÁöÑÊúÄÂ∞è‰ΩçÁßªÂ§Ñ</li>
<li>DurationÔºöÊää‰ΩçÁßªË∞ÉÊï¥Âà∞Ë∑ùÁ¶ªÂΩìÂâçÊó∂Èó¥ÊåáÂÆöÈó¥Èöî‰ΩçÁßªÂ§Ñ</li>
</ul>
<p><strong>ÊñπÊ≥ï</strong></p>
<ul>
<li>ÈÄöËøáJava APIÈáçËÆæ‰ΩçÁßªÔºöË∞ÉÁî®KafkaConsumerÁöÑseekÊñπÊ≥ïÔºåÊàñËÄÖÂÆÉÁöÑÂèòÁßçÊñπÊ≥ïseekToBeginningÂíåseekToEnd</li>
<li>Áî®ËÑöÊú¨kafka-consumer-groupsËÑöÊú¨</li>
</ul>
<h4 id="ËÑöÊú¨Â∑•ÂÖ∑"><a href="#ËÑöÊú¨Â∑•ÂÖ∑" class="headerlink" title="ËÑöÊú¨Â∑•ÂÖ∑"></a>ËÑöÊú¨Â∑•ÂÖ∑</h4><ul>
<li><p>kafka-aclsÔºöËÆæÁΩÆKafkaÊùÉÈôê</p>
</li>
<li><p>kafka-broker-api-versionsÔºöÈ™åËØÅ‰∏çÂêåKafkaÁâàÊú¨Áõ¥Êé•ÊúçÂä°Âô®‰∏éÂÆ¢Êà∑Á´ØÁöÑÈÄÇÈÖçÊÄß</p>
</li>
<li><p>kafka-configÔºöÂä®ÊÄÅÂèÇÊï∞ÈÖçÁΩÆ</p>
</li>
<li><p>kafka-console-consumerÔºöÊ∂àË¥πÁªÑËÑöÊú¨</p>
<pre><code class="bash">bin/kafka-console-consumer.sh --bootstrap-server kafka-host:port --topic test-topic --group test-group --from-beginning --consumer-property enable.auto.commit=false 
#ÊåáÂÆö‰∫Ü group ‰ø°ÊÅØ„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÊåáÂÆöÁöÑËØùÔºåÊØèÊ¨°ËøêË°å Console ConsumerÔºåÂÆÉÈÉΩ‰ºöËá™Âä®ÁîüÊàê‰∏Ä‰∏™Êñ∞ÁöÑÊ∂àË¥πËÄÖÁªÑÊù•Ê∂àË¥π</code></pre>
</li>
<li><p>kafka-console-producerÔºöÁîü‰∫ßËÄÖËÑöÊú¨</p>
<pre><code class="bash">bin/kafka-console-producer.sh --broker-list kafka-host:port --topic test-topic --request-required-acks -1 --producer-property compression.type=lz4
&gt;
#ÊåáÂÆöÁîü‰∫ßËÄÖÂèÇÊï∞ acks ‰∏∫ -1ÔºåÂêåÊó∂ÂêØÁî®‰∫Ü LZ4 ÁöÑÂéãÁº©ÁÆóÊ≥ï„ÄÇËøô‰∏™ËÑöÊú¨ÂèØ‰ª•ÂæàÊñπ‰æøÂú∞ËÆ©Êàë‰ª¨‰ΩøÁî®ÊéßÂà∂Âè∞Êù•Âêë Kafka ÁöÑÊåáÂÆö‰∏ªÈ¢òÂèëÈÄÅÊ∂àÊÅØ  </code></pre>
</li>
<li><p>kafka-producer-perf-testÔºöÁîü‰∫ßËÄÖÊµãËØïÂ∑•ÂÖ∑</p>
<pre><code class="bash">bin/kafka-producer-perf-test.sh --topic test-topic --num-records 10000000 --throughput -1 --record-size 1024 --producer-props bootstrap.servers=kafka-host:port acks=-1 linger.ms=2000 compression.type=lz4
#ÂêëÊåáÂÆö‰∏ªÈ¢òÂèëÈÄÅ‰∫Ü 1 ÂçÉ‰∏áÊù°Ê∂àÊÅØÔºåÊØèÊù°Ê∂àÊÅØÂ§ßÂ∞èÊòØ 1KB„ÄÇ</code></pre>
</li>
<li><p>kafka-consumer-perf-testÔºöÊ∂àË¥πËÄÖÊµãËØïÂ∑•ÂÖ∑</p>
<pre><code class="bash">bin/kafka-consumer-perf-test.sh --broker-list kafka-host:port --messages 10000000 --topic test-topic</code></pre>
</li>
<li><p>kafka-consumer-groupsÔºöÊü•ÁúãÊ∂àË¥πÁªÑ‰ΩçÁßª</p>
<pre><code class="bash">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group test-group</code></pre>
</li>
<li><p>kafka-dump-logÔºöÊü•ÁúãkafkaÊ∂àÊÅØÊñá‰ª∂ÂÜÖÂÆπÔºåÂåÖÂê´ÂêÑËá™ÂÖÉÊï∞ÊçÆ‰ø°ÊÅØ</p>
<pre><code class="bash">$ bin/kafka-dump-log.sh --files ../data_dir/kafka_1/test-topic-1/00000000000000000000.log </code></pre>
</li>
<li><p>kafka-log-dirsÔºöÊü•ËØ¢ÂêÑ‰∏™Broker‰∏äÊó•ÂøóË∑ØÁ∫ø‰∏ãÁöÑÁ£ÅÁõòÂç†Áî®ÊÉÖÂÜµ</p>
</li>
<li><p>kafka-mirror-makerÔºöÂÆûÁé∞ÈõÜÁæ§Ê∂àÊÅØÂêåÊ≠•</p>
</li>
<li><p>kafka-preferred-replica-electionÔºöÊâßË°å Preferred Leader ÈÄâ‰∏æÁöÑ</p>
</li>
<li><p>kafka-reassign-partitionsÔºöÊâßË°åÂàÜÂå∫ÂâØÊú¨ËøÅÁßªÂèäÂâØÊú¨Êñá‰ª∂Ë∑ØÂæÑËøÅÁßª</p>
</li>
<li><p>kafka-topicsÔºö‰∏ªÈ¢òÁÆ°ÁêÜ</p>
</li>
</ul>
<p>ÊâÄÊúâÁöÑËÑöÊú¨ÈÉΩÂèØ‰ª•Áî® ‚ÄìhelpÊù•Êü•ÁúãÈÄâÈ°πÔºåÊØîÂ¶Ç<code>./kafka-console-consumer.sh --help</code></p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>Eric</li><li class="post-copyright-link"><strong>Post link: </strong><a href="http://soda1.github.io/2023/03/01/kafka/02.%E8%BF%9B%E9%98%B6/" title="KafkaËøõÈò∂">http://soda1.github.io/2023/03/01/kafka/02.%E8%BF%9B%E9%98%B6/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> unless otherwise stated.</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2023/03/09/mysql/%E9%AB%98%E7%BA%A7/mysql%E6%89%A9%E5%AE%B9/" rel="prev" title="mysqlÊâ©ÂÆπ"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">mysqlÊâ©ÂÆπ</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2023/02/28/kafka/01.kafka%E5%85%A5%E9%97%A8/" rel="next" title="KafkaÂÖ•Èó®"><span class="post-nav-text">KafkaÂÖ•Èó®</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><style>.utterances {
  max-width: 100%;
}</style><script src="https://utteranc.es/client.js" repo="soda1/soda1.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 ‚Äì 2023 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Eric</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.2.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.9</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Searching..." value=""></div><div class="search-result-container"></div></div><div class="aplayer no-destroy" id="aplayer" data-id="308168565" data-server="netease" data-type="playlist" data-fixed="true" data-theme="#0078E7" data-loop="all" data-order="list" data-preload="auto" data-volume="0.7" data-mutex data-lrctype="0" data-listmaxheight="340px" data-storagename="metingjs"></div></body></html>