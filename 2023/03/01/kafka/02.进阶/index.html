<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Eric"><meta name="copyright" content="Eric"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>Kafkaè¿›é˜¶ | Eric's blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link class="aplayer-style-marker" rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.css"><script class="aplayer-script-marker" src="https://fastly.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.js" defer></script><script class="meting-script-marker" src="https://fastly.jsdelivr.net/npm/meting@1/dist/Meting.min.js" defer></script><script src="https://fastly.jsdelivr.net/npm/pjax@latest/pjax.min.js" defer></script><script src="/js/pjax.js" defer type="module"></script><script src="https://fastly.jsdelivr.net/npm/vue@2.6.14"></script><link rel="icon" type="image/png" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="prefetch" href="/js/sakura.js" as="script"><link rel="prefetch" href="/js/load-aplayer.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"soda1.github.io","root":"/","title":"Ericã®å°å±‹","version":"1.10.9","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="Eric's blog" type="application/atom+xml"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js" defer></script><script src="/js/load-aplayer.js" defer></script><meta name="description" content="åˆ†åŒºæœºåˆ¶åˆ†åŒºçš„ä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†æé«˜è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œæ•°æ®çš„è¯»å†™éƒ½æ˜¯åœ¨åˆ†åŒºè¿™ä¸ªç²’åº¦ä¸Šè¿›è¡Œçš„ï¼Œä»è€Œå®ç°äº†ç³»ç»Ÿçš„å¯ä¼¸ç¼©æ€§ åˆ†åŒºç­–ç•¥åˆ†åŒºç­–ç•¥å†³å®šè€…ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€è‡³å“ªä¸ªåŒºï¼Œå¦‚æœç”Ÿäº§è€…è¦å®šä¹‰ä¸€ä¸ªåˆ†åŒºç­–ç•¥ï¼Œè¦åœ¨å®¢æˆ·ç«¯å®ç°org.apache.kafka.clients.producer.Partitioneræ¥å£ï¼Œå¸¸è§åˆ†åŒºç­–ç•¥å¦‚ä¸‹ï¼š  è½®è¯¢ç­–ç•¥ï¼ˆ Round-robinï¼‰ Kafkaé»˜è®¤ç­–ç•¥ï¼Œé¡ºåºåˆ†é…ï¼Œå°±æ˜¯å–ä½™æ“">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafkaè¿›é˜¶">
<meta property="og:url" content="http://soda1.github.io/2023/03/01/kafka/02.%E8%BF%9B%E9%98%B6/index.html">
<meta property="og:site_name" content="Eric&#39;s blog">
<meta property="og:description" content="åˆ†åŒºæœºåˆ¶åˆ†åŒºçš„ä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†æé«˜è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œæ•°æ®çš„è¯»å†™éƒ½æ˜¯åœ¨åˆ†åŒºè¿™ä¸ªç²’åº¦ä¸Šè¿›è¡Œçš„ï¼Œä»è€Œå®ç°äº†ç³»ç»Ÿçš„å¯ä¼¸ç¼©æ€§ åˆ†åŒºç­–ç•¥åˆ†åŒºç­–ç•¥å†³å®šè€…ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€è‡³å“ªä¸ªåŒºï¼Œå¦‚æœç”Ÿäº§è€…è¦å®šä¹‰ä¸€ä¸ªåˆ†åŒºç­–ç•¥ï¼Œè¦åœ¨å®¢æˆ·ç«¯å®ç°org.apache.kafka.clients.producer.Partitioneræ¥å£ï¼Œå¸¸è§åˆ†åŒºç­–ç•¥å¦‚ä¸‹ï¼š  è½®è¯¢ç­–ç•¥ï¼ˆ Round-robinï¼‰ Kafkaé»˜è®¤ç­–ç•¥ï¼Œé¡ºåºåˆ†é…ï¼Œå°±æ˜¯å–ä½™æ“">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303190703.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303190823.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303192421.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303192537.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303160430.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230305165243.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230305165811.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230305172705.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230305235446.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230306010801.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230306151424.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303184103.png">
<meta property="og:image" content="https://raw.githubusercontent.com/soda1/img/main/20230304145246.png">
<meta property="article:published_time" content="2023-03-01T15:15:20.000Z">
<meta property="article:modified_time" content="2023-03-06T19:56:48.000Z">
<meta property="article:author" content="Eric">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/soda1/img/main/20230303190703.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Eric"><img width="96" loading="lazy" src="/yun.png" alt="Eric"><span class="site-author-status" title="çƒ­çˆ±å¯æŠµå²æœˆæ¼«é•¿">ğŸ˜Š</span></a><div class="site-author-name"><a href="/about/">Eric</a></div><span class="site-name">Eric's blog</span><sub class="site-subtitle"></sub><div class="site-description">The best way is to get your hands dirty</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">72</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">11</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">0</span></a></div><a class="site-state-item hty-icon-button" href="/about" title="About"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E6%9C%BA%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">åˆ†åŒºæœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5"><span class="toc-number">1.1.</span> <span class="toc-text">åˆ†åŒºç­–ç•¥</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%A7%A3%E5%8E%8B%E7%BC%A9"><span class="toc-number">2.</span> <span class="toc-text">æ¶ˆæ¯è§£å‹ç¼©</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">æ— æ¶ˆæ¯ä¸¢å¤±é…ç½®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">æ‹¦æˆªå™¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Producer%E4%B8%80%E6%AC%A1%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">Producerä¸€æ¬¡å‘é€æµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Message-Delivery-Semantics"><span class="toc-number">6.</span> <span class="toc-text">Message Delivery Semantics</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Kafka%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81exactly-once"><span class="toc-number">6.1.</span> <span class="toc-text">Kafkaå¦‚ä½•ä¿è¯exactly once</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">6.1.1.</span> <span class="toc-text">å¹‚ç­‰æ€§</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">6.1.2.</span> <span class="toc-text">äº‹åŠ¡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%9C%BA%E5%88%B6"><span class="toc-number">7.</span> <span class="toc-text">æ¶ˆè´¹æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Consumer-Group"><span class="toc-number">7.1.</span> <span class="toc-text">Consumer Group</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%A4%E5%A4%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">7.1.1.</span> <span class="toc-text">å®ç°ä¸¤å¤§æ¨¡å‹</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Standalone-Consumer"><span class="toc-number">7.2.</span> <span class="toc-text">Standalone Consumer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#consumer-offsets"><span class="toc-number">7.3.</span> <span class="toc-text">_consumer_offsets</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Coordinator%E7%BB%84%E4%BB%B6"><span class="toc-number">7.4.</span> <span class="toc-text">Coordinatorç»„ä»¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Rebalance"><span class="toc-number">7.5.</span> <span class="toc-text">Rebalance</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Rebalance%E8%A6%81%E7%82%B9"><span class="toc-number">7.5.1.</span> <span class="toc-text">Rebalanceè¦ç‚¹</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Consumer%E9%87%8D%E5%B9%B3%E8%A1%A1%E6%AD%A5%E9%AA%A4"><span class="toc-number">7.5.2.</span> <span class="toc-text">Consumeré‡å¹³è¡¡æ­¥éª¤</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%8D%E7%A7%BB%E6%8F%90%E4%BA%A4"><span class="toc-number">7.6.</span> <span class="toc-text">ä½ç§»æäº¤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Consumer%E5%BB%BA%E7%AB%8BTCP%E8%BF%9E%E6%8E%A5%E7%A7%8D%E7%B1%BB"><span class="toc-number">7.7.</span> <span class="toc-text">Consumerå»ºç«‹TCPè¿æ¥ç§ç±»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%BF%9B%E5%BA%A6%E7%9B%91%E6%8E%A7"><span class="toc-number">7.8.</span> <span class="toc-text">æ¶ˆè´¹è¿›åº¦ç›‘æ§</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%AF%E6%9C%AC%E6%9C%BA%E5%88%B6"><span class="toc-number">8.</span> <span class="toc-text">å‰¯æœ¬æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#In-sync-Replicas%EF%BC%88ISR%EF%BC%89"><span class="toc-number">8.1.</span> <span class="toc-text">In-sync Replicasï¼ˆISRï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Unclean-Leader-Election"><span class="toc-number">8.2.</span> <span class="toc-text">Unclean Leader Election</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#High-Watermark-HW"><span class="toc-number">8.3.</span> <span class="toc-text">High Watermark(HW)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">8.3.1.</span> <span class="toc-text">æ›´æ–°æœºåˆ¶</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Broker"><span class="toc-number">9.</span> <span class="toc-text">Broker</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Broker%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">9.1.</span> <span class="toc-text">Brokerç½‘ç»œæ¨¡å‹</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller"><span class="toc-number">10.</span> <span class="toc-text">Controller</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">10.1.</span> <span class="toc-text">ä½œç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%80%89%E4%B8%BE"><span class="toc-number">10.2.</span> <span class="toc-text">å¦‚ä½•é€‰ä¸¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86"><span class="toc-number">10.3.</span> <span class="toc-text">å¤±æ•ˆå¤„ç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E8%AE%BE%E8%AE%A1%E7%BB%93%E6%9E%84"><span class="toc-number">10.4.</span> <span class="toc-text">å†…éƒ¨è®¾è®¡ç»“æ„</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81Broker%E5%8F%82%E6%95%B0"><span class="toc-number">11.</span> <span class="toc-text">åŠ¨æ€Brokerå‚æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%AE%BE%E6%B6%88%E8%B4%B9%E7%BB%84%E4%BD%8D%E7%A7%BB"><span class="toc-number">12.</span> <span class="toc-text">é‡è®¾æ¶ˆè´¹ç»„ä½ç§»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E5%B7%A5%E5%85%B7"><span class="toc-number">13.</span> <span class="toc-text">è„šæœ¬å·¥å…·</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://soda1.github.io/2023/03/01/kafka/02.%E8%BF%9B%E9%98%B6/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Eric"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Eric's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Kafkaè¿›é˜¶</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <span class="post-meta-icon-text">Posted on</span> <time title="Created: 2023-03-01 15:15:20" itemprop="dateCreated datePublished" datetime="2023-03-01T15:15:20+00:00">2023-03-01</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <span class="post-meta-icon-text">Edited on</span> <time title="Modified: 2023-03-06 19:56:48" itemprop="dateModified" datetime="2023-03-06T19:56:48+00:00">2023-03-06</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="Word count in article">5.8k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="Reading time">22m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Kafka/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Kafka</span></a></span></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h4 id="åˆ†åŒºæœºåˆ¶"><a href="#åˆ†åŒºæœºåˆ¶" class="headerlink" title="åˆ†åŒºæœºåˆ¶"></a>åˆ†åŒºæœºåˆ¶</h4><p>åˆ†åŒºçš„ä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†æé«˜è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œæ•°æ®çš„è¯»å†™éƒ½æ˜¯åœ¨åˆ†åŒºè¿™ä¸ªç²’åº¦ä¸Šè¿›è¡Œçš„ï¼Œä»è€Œå®ç°äº†ç³»ç»Ÿçš„å¯ä¼¸ç¼©æ€§</p>
<h5 id="åˆ†åŒºç­–ç•¥"><a href="#åˆ†åŒºç­–ç•¥" class="headerlink" title="åˆ†åŒºç­–ç•¥"></a>åˆ†åŒºç­–ç•¥</h5><p>åˆ†åŒºç­–ç•¥å†³å®šè€…ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€è‡³å“ªä¸ªåŒºï¼Œå¦‚æœç”Ÿäº§è€…è¦å®šä¹‰ä¸€ä¸ªåˆ†åŒºç­–ç•¥ï¼Œè¦åœ¨å®¢æˆ·ç«¯å®ç°<code>org.apache.kafka.clients.producer.Partitioner</code>æ¥å£ï¼Œå¸¸è§åˆ†åŒºç­–ç•¥å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>è½®è¯¢ç­–ç•¥ï¼ˆ Round-robinï¼‰</p>
<p>Kafkaé»˜è®¤ç­–ç•¥ï¼Œé¡ºåºåˆ†é…ï¼Œå°±æ˜¯å–ä½™æ“ä½œï¼Œ$ partition_index = n % partition_num $ï¼Œnè¡¨ç¤ºç¬¬næ¡æ¶ˆæ¯ã€‚è½®è¯¢ç­–ç•¥æœ‰ç€å¾ˆå¥½çš„è´Ÿè½½å‡è¡¡è¡¨ç°ã€‚</p>
</li>
<li><p>éšæœºç­–ç•¥ï¼ˆRandomnessï¼‰</p>
<p>éšæœºè¿”å›ä¸€ä¸ªpartition</p>
</li>
<li><p>æŒ‰æ¶ˆæ¯é”®ä¿åºç­–ç•¥</p>
<p>Kafkaå…è®¸ä¸ºæ¯æ¡æ¶ˆæ¯éƒ½å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯é”®ï¼Œå¯ä»¥é€šè¿‡å¯¹é”®è¿›è¡Œhashä»è€Œä¿å­˜åˆ°ç‰¹å®šçš„partitionä¸­ã€‚è¿™ä¹Ÿæ˜¯Kafkaçš„é»˜è®¤ç­–ç•¥ä¹‹ä¸€ï¼Œå‡è®¾å®¢æˆ·ç«¯æ²¡æœ‰è‡ªå®šä¹‰ç­–ç•¥ï¼Œå¦‚æœæ˜¯æ¶ˆæ¯ä¸­å¸¦ç€Keyï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œè¿™ä¸ªç­–ç•¥ï¼Œå¦åˆ™å°±ä½¿ç”¨è½®è¯¢ç­–ç•¥</p>
</li>
</ul>
<p>spring bootå®ç°ä¾‹å­</p>
<pre><code class="java">public class MyPartitioner implements Partitioner &#123;
    @Override
    public int partition(String s, Object o, byte[] bytes, Object o1, byte[] bytes1, Cluster cluster) &#123;
        List&lt;PartitionInfo&gt; partitionInfos = cluster.availablePartitionsForTopic(s);
        int num = ThreadLocalRandom.current().nextInt(partitionInfos.size());
        System.out.println(num);
        return num;
    &#125;
    .........
&#125;</code></pre>
<p>é…ç½®partitionerè·¯å¾„ï¼Œè¿™ä¸ªåœ¨ymlä¸­æ²¡æœ‰æ‰¾åˆ°å±æ€§ï¼Œç”¨ä»£ç æ¥é…ç½®</p>
<pre><code class="java">    @Bean
    public Map&lt;String, Object&gt; producerConfigs() &#123;
        Map&lt;String, Object&gt; props = new HashMap&lt;&gt;();
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;192.168.3.100:9092&quot;);
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, IntegerSerializer.class);
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        props.put(ProducerConfig.PARTITIONER_CLASS_CONFIG, MyPartitioner.class);
        // See https://kafka.apache.org/documentation/#producerconfigs for more properties
        return props;
    &#125;
    @Bean
    public ProducerFactory&lt;Integer, String&gt; producerFactory() &#123;
        return new DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());
    &#125;
    @Bean
    public KafkaTemplate&lt;Integer, String&gt; kafkaTemplate() &#123;
        return new KafkaTemplate&lt;Integer, String&gt;(producerFactory());
    &#125;</code></pre>
<h4 id="æ¶ˆæ¯è§£å‹ç¼©"><a href="#æ¶ˆæ¯è§£å‹ç¼©" class="headerlink" title="æ¶ˆæ¯è§£å‹ç¼©"></a>æ¶ˆæ¯è§£å‹ç¼©</h4><ul>
<li><p>Producerç«¯å‹ç¼©</p>
<p>Producerå®¢æˆ·ç«¯å¼€å¯å‹ç¼©ç®—æ³•åªè¦åœ¨<code>compression.type</code>é…ç½®æŒ‡å®šçš„ç±»å‹ç®—æ³•å³å¯ï¼Œåœ¨Producerç«¯é…ç½®å¥½å¤„åœ¨äºæœ‰åˆ©äºç½‘ç»œä¼ è¾“</p>
</li>
<li><p>Brokerç«¯å‹ç¼©</p>
<p>Brokerä¹Ÿæœ‰å¯èƒ½ä¼šå¯¹æ¶ˆæ¯è¿›è¡Œå‹ç¼©ï¼Œæœ‰å¦‚ä¸‹æƒ…å†µ</p>
<p>æƒ…å†µ1ï¼šBrokerç«¯å’ŒProducerç«¯å‹ç¼©ç®—æ³•ä¸ä¸€è‡´äº§ç”Ÿ</p>
<p>æƒ…å†µ2ï¼šå› æ¶ˆæ¯ç‰ˆæœ¬ä¸åŒåŸå› å‘ç”Ÿçš„å…¼å®¹æ ¼å¼è½¬æ¢äº§ç”Ÿ</p>
</li>
<li><p>Brokerç«¯è§£å‹</p>
<p>Brokerç«¯éœ€è¦å¯¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯è¿›è¡ŒéªŒè¯ï¼Œæ¯”å¦‚CRCæ ¡éªŒï¼Œå› æ­¤ä¼šè§£å‹æ¶ˆæ¯</p>
</li>
<li><p>Consumerç«¯è§£å‹</p>
<p>Consumeræ¶ˆè´¹æ¶ˆæ¯éœ€è¦å…ˆè§£å‹è¿˜åŸæ¶ˆæ¯</p>
</li>
</ul>
<p>æ¶ˆæ¯è§£å‹ç¼©æ•´ä¸ªæµç¨‹å¯ä»¥æ¦‚å†µä¸ºä¸€å¥è¯ï¼šProducer ç«¯å‹ç¼©ã€Broker ç«¯ä¿æŒã€Consumer ç«¯è§£å‹ã€‚</p>
<p>å‹ç¼©ç®—æ³•æ¯”è¾ƒ</p>
<p>ååé‡ï¼šLZ4 &gt; Snappy &gt; zstd å’Œ GZIP</p>
<p>å‹ç¼©æ¯”ï¼šzstd &gt; LZ4 &gt; GZIP &gt; Snappy</p>
<h4 id="æ— æ¶ˆæ¯ä¸¢å¤±é…ç½®"><a href="#æ— æ¶ˆæ¯ä¸¢å¤±é…ç½®" class="headerlink" title="æ— æ¶ˆæ¯ä¸¢å¤±é…ç½®"></a>æ— æ¶ˆæ¯ä¸¢å¤±é…ç½®</h4><p>Producer</p>
<ul>
<li>Producerå‘é€æ¶ˆæ¯è¦ä½¿ç”¨å¸¦å›è°ƒçš„send(msg, callback)</li>
<li>Producerè®¾ç½®acks=allï¼Œè¡¨ç¤ºæ‰€æœ‰in-sync replicaséƒ½å·²ç»æ¥æ”¶åˆ°æ¶ˆæ¯äº†ï¼Œæ¶ˆæ¯æ‰ç®—å‘é€æˆåŠŸ</li>
<li>Producersè®¾ç½®retriesï¼Œæ¶ˆæ¯å‘é€å¤±è´¥æ—¶åº”å½“é‡è¯•å¤šæ¬¡ï¼Œè¿˜ä¸è¡Œå†å¦ä½œå¤„ç†</li>
</ul>
<p>Brokerç«¯</p>
<ul>
<li><p>unclean.leader.election.enable = falseï¼Œè½åå¤ªå¤šçš„å‰¯æœ¬ä¸åº”å½“ç«é€‰leader</p>
</li>
<li><p>replication.factor &gt;= 3ï¼Œå°†å‰¯æœ¬å¤šä¿å­˜å‡ ä»½</p>
</li>
<li><p>min.insync.replicas &gt; 1ï¼Œè¿™ä¸ªé…ç½®æ˜¯ä¿è¯å½“Producerçš„ack=allæ—¶ï¼ŒBrokerç«¯è‡³å°‘å­˜åœ¨å¤šå°‘ä¸ªin-sync replicasæ‰èƒ½è¿›è¡Œå†™å…¥ã€‚å¯å‚è€ƒ<a target="_blank" rel="noopener" href="https://accu.org/journals/overload/28/159/kozlovski/" title="Kafka Acks Explained">æ–‡ç« </a>ã€‚</p>
<p>è¦é…ç½®replication.factor &gt; min.insync.replicasï¼Œå¦åˆ™ä¸€ä¸ªå‰¯æœ¬æŒ‚äº†åˆ†åŒºå°±ä¸å¯ç”¨äº†ã€‚æ¨èæˆreplication.factor = min.insync.replicas + 1</p>
</li>
</ul>
<p>Consumer</p>
<ul>
<li>enable.auto.commitè®¾ç½®ä¸ºfalseï¼Œæ”¹ä¸ºæ‰‹åŠ¨æäº¤ï¼Œå¹¶é‡‡ç”¨æ‰‹åŠ¨æäº¤ä½ç§»</li>
</ul>
<h4 id="æ‹¦æˆªå™¨"><a href="#æ‹¦æˆªå™¨" class="headerlink" title="æ‹¦æˆªå™¨"></a>æ‹¦æˆªå™¨</h4><p>todo</p>
<h4 id="Producerä¸€æ¬¡å‘é€æµç¨‹"><a href="#Producerä¸€æ¬¡å‘é€æµç¨‹" class="headerlink" title="Producerä¸€æ¬¡å‘é€æµç¨‹"></a>Producerä¸€æ¬¡å‘é€æµç¨‹</h4><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ„é€ ç”Ÿäº§è€…å¯¹è±¡æ‰€éœ€çš„å‚æ•°å¯¹è±¡</li>
<li>æ ¹æ®å‚æ•°åˆ›å»ºKafkaProducerå¯¹è±¡å®ä¾‹</li>
<li>è°ƒç”¨sendæ–¹æ³•å‘é€æ¶ˆæ¯</li>
<li>è°ƒç”¨closeæ–¹æ³•é‡Šæ”¾èµ„æº</li>
</ol>
<p>æ·±å…¥ï¼š</p>
<ol>
<li>åœ¨åˆ›å»ºKafkaProducerå¯¹è±¡æ—¶åå°ä¼šåˆ›å»ºä¸€ä¸ªåä¸ºSeederçš„çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¼šä¸ bootstrap.serversé…ç½®çš„æ‰€æœ‰Brokerè¿›è¡ŒTcpè¿æ¥ï¼Œç”¨äºè·å–é›†ç¾¤å…ƒæ•°æ®ä¿¡æ¯ã€‚</li>
<li>Producerä¼šé€šè¿‡metadata.max.age.ms å‚æ•°æ¥å®šæœŸåœ°å»æ›´æ–°å…ƒæ•°æ®ä¿¡æ¯ï¼Œé»˜è®¤æ—¶5åˆ†é’Ÿã€‚</li>
<li>åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼ŒProducerä¼šä»å…ƒæ•°æ®ç¼“å­˜ä¸­æ‰¾åˆ°éœ€è¦å‘é€çš„Brokerä¿¡æ¯ï¼Œå»ºç«‹Tcpè¿æ¥æ¥å‘é€ä¿¡æ¯</li>
</ol>
<h4 id="Message-Delivery-Semantics"><a href="#Message-Delivery-Semantics" class="headerlink" title="Message Delivery Semantics"></a>Message Delivery Semantics</h4><p>æœ‰å¦‚ä¸‹ä¸‰ç§è¯­ä¹‰ä¿è¯ï¼š</p>
<ul>
<li><p>æœ€å¤šä¸€æ¬¡ï¼ˆat most onceï¼‰ï¼šæ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ï¼Œä½†ç»ä¸ä¼šè¢«é‡å¤å‘é€</p>
</li>
<li><p>è‡³å°‘ä¸€æ¬¡ï¼ˆat least onceï¼‰ï¼šæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œä½†æœ‰å¯èƒ½è¢«é‡å¤å‘é€</p>
</li>
<li><p>ç²¾ç¡®ä¸€æ¬¡ï¼ˆexactly onceï¼‰ï¼šæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œä¹Ÿä¸ä¼šè¢«é‡å¤å‘é€</p>
</li>
</ul>
<p>Kafkaé»˜è®¤æä¾›at least onceçš„å¯é æ€§ä¿è¯ï¼Œæä¾›äº†é‡è¯•çš„æœºåˆ¶ã€‚</p>
<h5 id="Kafkaå¦‚ä½•ä¿è¯exactly-once"><a href="#Kafkaå¦‚ä½•ä¿è¯exactly-once" class="headerlink" title="Kafkaå¦‚ä½•ä¿è¯exactly once"></a>Kafkaå¦‚ä½•ä¿è¯exactly once</h5><h6 id="å¹‚ç­‰æ€§"><a href="#å¹‚ç­‰æ€§" class="headerlink" title="å¹‚ç­‰æ€§"></a>å¹‚ç­‰æ€§</h6><p>åœ¨0.11ç‰ˆæœ¬å¼€å§‹æ”¯æŒï¼ŒBrokerç»™æ¯ä¸ªProduceråˆ†é…ä¸€ä¸ªIDï¼Œä¸”Producerçš„æ¯æ¡ä¿¡æ¯éƒ½ä¼šæœ‰ä¸€ä¸ªåºåˆ—å·ç”¨æ¥å»é‡ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡æŒ‡å®š<code>enable.idempotence=true</code>æ¥é…ç½®å¹‚ç­‰Producer</p>
<p>Kafkaåªèƒ½ä¿è¯å•åˆ†åŒºä¸Šçš„å¹‚ç­‰æ€§ï¼Œå³ä¸€ä¸ªå¹‚ç­‰æ€§ Producer èƒ½å¤Ÿä¿è¯æŸä¸ªä¸»é¢˜çš„ä¸€ä¸ªåˆ†åŒº ä¸Šä¸å‡ºç°é‡å¤æ¶ˆæ¯ï¼Œå®ƒæ— æ³•å®ç°å¤šä¸ªåˆ†åŒºçš„å¹‚ç­‰æ€§ã€‚å…¶æ¬¡ï¼Œå®ƒåªèƒ½å®ç°å•ä¼šè¯ä¸Šçš„å¹‚ç­‰æ€§ï¼Œä¸ èƒ½å®ç°è·¨ä¼šè¯çš„å¹‚ç­‰æ€§ã€‚è¿™é‡Œçš„ä¼šè¯ï¼Œä½ å¯ä»¥ç†è§£ä¸º Producer è¿›ç¨‹çš„ä¸€æ¬¡è¿è¡Œã€‚å½“ä½ é‡å¯äº† Producer è¿›ç¨‹ä¹‹åï¼Œè¿™ç§å¹‚ç­‰æ€§ä¿è¯å°±ä¸§å¤±äº†ã€‚</p>
<h6 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h6><p>ä»0.11ç‰ˆæœ¬å¼€å§‹æ”¯æŒï¼Œé€šè¿‡<code>ç½® isolation.level</code>æ¥è®¾ç½®äº‹åŠ¡çº§åˆ«ï¼Œæœ‰ä»¥ä¸‹å‚æ•°</p>
<ul>
<li>read_uncommittedï¼šé»˜è®¤å€¼ï¼Œè¡¨æ˜Consumerå¯ä»¥è¯»å–äº‹åŠ¡å‹Producerå†™å…¥çš„ä»»ä½•æ¶ˆæ¯</li>
<li>read_committedï¼šè¡¨æ˜ Consumer åªä¼šè¯»å–äº‹åŠ¡å‹ Producer æˆåŠŸæäº¤äº‹åŠ¡å†™å…¥çš„æ¶ˆ æ¯</li>
</ul>
<p>äº‹åŠ¡å‹Produceré€šè¿‡æµç¨‹ä»£ç æ§åˆ¶ï¼Œç±»ä¼¼mysqlé‚£æ ·(begin, commit)</p>
<p>äº‹åŠ¡å¯ä»¥ä¿è¯è·¨åˆ†åŒºï¼Œè·¨ä¼šè¯çš„å¹‚ç­‰ã€‚</p>
<h4 id="æ¶ˆè´¹æœºåˆ¶"><a href="#æ¶ˆè´¹æœºåˆ¶" class="headerlink" title="æ¶ˆè´¹æœºåˆ¶"></a>æ¶ˆè´¹æœºåˆ¶</h4><h5 id="Consumer-Group"><a href="#Consumer-Group" class="headerlink" title="Consumer Group"></a>Consumer Group</h5><p>Consumer Group æ˜¯ Kafka æä¾›çš„å¯æ‰©å±•ä¸”å…· æœ‰å®¹é”™æ€§çš„æ¶ˆè´¹è€…æœºåˆ¶ã€‚æ¯ä¸ªç»„éƒ½æœ‰ä¸€ä¸ªGroup IDï¼Œ ç»„å†…å­˜åœ¨å¤šä¸ªæ¶ˆè´¹å®ä¾‹å…±åŒæ¶ˆè´¹Topicæ‰€æœ‰çš„Partitionï¼Œ<strong>ä¸€ä¸ªPartitionåªèƒ½è¢«åˆ†é…ç»™ç»„å†…ä¸€ä¸ªConsumeræ¶ˆè´¹</strong>ã€‚</p>
<h6 id="å®ç°ä¸¤å¤§æ¨¡å‹"><a href="#å®ç°ä¸¤å¤§æ¨¡å‹" class="headerlink" title="å®ç°ä¸¤å¤§æ¨¡å‹"></a>å®ç°ä¸¤å¤§æ¨¡å‹</h6><p>Consumer Groupæ˜¯Kafkaå®ç°ä¸¤ä¸ªæ¨¡å‹çš„æœºåˆ¶</p>
<ul>
<li>åªæœ‰ä¸€ä¸ªç»„è¿›è¡Œæ¶ˆè´¹Topicï¼Œé‚£ä¹ˆå°±æ˜¯é˜Ÿåˆ—æ¨¡å‹</li>
<li>å¤šä¸ªç»„æ¶ˆè´¹Topicï¼Œé‚£ä¹ˆå°±æ˜¯å‘å¸ƒ/è®¢é˜…æ¨¡å‹</li>
</ul>
<h5 id="Standalone-Consumer"><a href="#Standalone-Consumer" class="headerlink" title="Standalone Consumer"></a>Standalone Consumer</h5><p>ç›¸å½“äºåªæœ‰ä¸€ä¸ªConsumerçš„æ¶ˆè´¹ç»„ï¼Œä¹Ÿéœ€è¦Group IDæ ‡è¯†</p>
<h5 id="consumer-offsets"><a href="#consumer-offsets" class="headerlink" title="_consumer_offsets"></a>_consumer_offsets</h5><p>_consumer_offsetsæ˜¯Kafkaå†…éƒ¨Topicï¼Œå®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯ä¸ºäº†ä¿æŒConsumeræ¶ˆè´¹çš„ä½ç§»ä¿¡æ¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ™®é€šçš„Topicï¼Œå¯ä»¥å¯¹å®ƒè¿›è¡Œæ“ä½œï¼Œä½†è¯·ä¸è¦è¿™ä¹ˆåš</p>
<ol>
<li><p>åˆ›å»ºæ—¶æœº</p>
<p>å½“ Kafka é›†ç¾¤ä¸­çš„ç¬¬ä¸€ä¸ª Consumer ç¨‹åºå¯åŠ¨æ—¶ï¼ŒKafka ä¼šè‡ªåŠ¨åˆ›å»ºä½ç§»ä¸»é¢˜ï¼Œé»˜è®¤åˆ†åŒºæ•°æ˜¯50ï¼Œå‰¯æœ¬æ•°3ã€‚å¯ä»¥é€šè¿‡<code>offsets.topic.num.partitions</code>ã€<code>offsets.topic.replication.factor</code>é…ç½®ï¼Œä½†ä¸å»ºè®®</p>
</li>
<li><p>æ¶ˆæ¯æ ¼å¼</p>
<ul>
<li><p>ä½ç§»ä¿¡æ¯æ ¼å¼</p>
<p>ä¿å­˜çš„æ¶ˆæ¯æ ¼å¼æ˜¯KVå¯¹ï¼ŒKeyç”¨&lt;Group ID, Topic, Partition&gt;æ¥æ ‡è¯†ï¼Œ Valueä¿å­˜ä½ç§»å€¼</p>
</li>
<li><p>ä¿å­˜ Consumer Group ä¿¡æ¯çš„æ¶ˆæ¯</p>
<p>ç”¨äºæ³¨å†ŒConsumer Group</p>
</li>
<li><p>tombstoneæ¶ˆæ¯</p>
<p>åˆ é™¤ Group è¿‡æœŸä½ç§»ç”šè‡³æ˜¯åˆ é™¤ Group çš„æ¶ˆæ¯</p>
</li>
</ul>
</li>
<li><p>Groupæ•°æ®ä¿å­˜åœ¨å“ªä¸ªåŒºï¼Ÿ</p>
<p>$$partitionId=Math.abs(groupId.hashCode() % offsetsTopicPartitionCount)$$</p>
</li>
<li><p>Compact ç­–ç•¥</p>
<p>Kafka ä½¿ç”¨Compact ç­–ç•¥æ¥åˆ é™¤ä½ç§»ä¸»é¢˜ä¸­çš„è¿‡æœŸæ¶ˆæ¯ï¼Œé¿å…è¯¥ä¸»é¢˜æ— é™æœŸ è†¨èƒ€ã€‚è¿‡æœŸå®šä¹‰ï¼šå¯¹äºåŒä¸€ä¸ª Key çš„ä¸¤æ¡æ¶ˆæ¯ M1 å’Œ M2ï¼Œå¦‚æœ M1 çš„å‘é€æ—¶é—´æ—©äº M2ï¼Œé‚£ä¹ˆ M1 å°±æ˜¯è¿‡æœŸæ¶ˆæ¯ã€‚Compact çš„è¿‡ç¨‹å°±æ˜¯æ‰«ææ—¥å¿— çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œå‰”é™¤é‚£äº›è¿‡æœŸçš„æ¶ˆæ¯ï¼Œç„¶åæŠŠå‰©ä¸‹çš„æ¶ˆæ¯æ•´ç†åœ¨ä¸€èµ·ã€‚</p>
<p>Kafka æä¾›äº†ä¸“é—¨çš„åå°çº¿ç¨‹ï¼ˆ Log Cleanerï¼‰å®šæœŸåœ°å·¡æ£€å¾… Compact çš„ä¸»é¢˜ï¼Œçœ‹çœ‹æ˜¯å¦å­˜åœ¨æ»¡è¶³æ¡ä»¶çš„å¯åˆ  é™¤æ•°æ®</p>
</li>
</ol>
<h5 id="Coordinatorç»„ä»¶"><a href="#Coordinatorç»„ä»¶" class="headerlink" title="Coordinatorç»„ä»¶"></a>Coordinatorç»„ä»¶</h5><p>æ¯ä¸ªBrokeréƒ½æœ‰å„è‡ªçš„Coordinatorç»„ä»¶ï¼Œå®ƒæ˜¯ä¸“é—¨ä¸ºConsumer GroupæœåŠ¡çš„ï¼Œè´Ÿè´£ä¸º Group æ‰§è¡Œ Rebalance ä»¥åŠæä¾›ä½ç§»ç®¡ç†å’Œç»„æˆå‘˜ç®¡ç†</p>
<p>å¦‚ä½•çŸ¥é“Groupè¢«å“ªä¸ªCoordinatorç®¡ç†ï¼Ÿ</p>
<ol>
<li>ç¡®å®šç”±çš„å“ªä¸ª_consumer_offsetsåˆ†åŒºæ¥ä¿å­˜è¯¥ Group æ•°æ®ï¼ˆ_consumer_offsetsä¿å­˜ç®—æ³•ï¼‰</li>
<li>æ‰¾å‡ºè¯¥åˆ†åŒº Leader å‰¯æœ¬æ‰€åœ¨çš„ Brokerï¼Œè¯¥ Broker å³ä¸ºå¯¹åº”çš„ Coordinatorã€‚</li>
</ol>
<h5 id="Rebalance"><a href="#Rebalance" class="headerlink" title="Rebalance"></a>Rebalance</h5><p>Kafkaå¯¹Consumer Groupé‡æ–°åˆ†é…Partitionçš„è¿‡ç¨‹ç§°ä¸ºRebalanceã€‚Rebalance å‘ç”Ÿæ—¶ï¼ŒGroup ä¸‹æ‰€æœ‰çš„ Consumer å®ä¾‹éƒ½ä¼šåè°ƒåœ¨ä¸€èµ·å…±åŒå‚ä¸ï¼Œåœ¨åè°ƒè€…ç»„ä»¶çš„å¸®åŠ©ä¸‹ï¼Œå®Œæˆè®¢é˜…ä¸»é¢˜åˆ†åŒºçš„åˆ†é…</p>
<ol>
<li><p>ä½•æ—¶è§¦å‘ï¼Ÿ</p>
<ul>
<li>ç»„æˆå‘˜æ•°æ”¹å˜</li>
<li>è®¢é˜…ä¸»é¢˜æ•°æ”¹å˜</li>
<li>è®¢é˜…ä¸»é¢˜åˆ†åŒºæ•°æ”¹å˜</li>
</ul>
</li>
<li><p>äº§ç”Ÿå½±å“</p>
<p>åœ¨Rebalanceè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰çš„Consumeréƒ½ä¼šåœæ­¢æ¶ˆè´¹ï¼Œå¦‚æœæœ‰Consumeræ­£åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„è¯ï¼Œå°†ä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜</p>
</li>
<li><p>Coordinatorå¦‚ä½•åˆ¤æ–­Consumerå®ä¾‹é€€ç»„</p>
<p>å¿ƒè·³æœºåˆ¶ï¼Œæ¯ä¸ªConsumeréƒ½ä¼šå®šæœŸçš„å‘Coordinatorå‘é€å¿ƒè·³ï¼Œå¦‚æœä¸èƒ½åŠæ—¶å‘é€å¿ƒè·³ï¼Œé‚£ä¹ˆCoordinatorå°±ä¼šè®¤ä¸ºè¯¥Consumeré€€ç»„ï¼Œè¿›è€Œå¼€å§‹Rebalanceã€‚</p>
<p>Consumerç«¯ç›¸å…³å‚æ•°</p>
<ul>
<li><code>heartbeat.interval.ms</code>ï¼šå¿ƒè·³è¯·æ±‚é¢‘ç‡å‚æ•°</li>
<li><code>max.poll.interval.ms</code>ï¼š ä¸¤æ¬¡è°ƒ ç”¨ poll æ–¹æ³•çš„æœ€å¤§æ—¶é—´é—´éš”ã€‚å®ƒçš„é»˜è®¤å€¼æ˜¯ 5 åˆ†é’Ÿã€‚åœ¨ä¸¤æ¬¡è°ƒç”¨pollçš„é—´éš”é—´ï¼Œä¸šåŠ¡é€»è¾‘å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œè¶…å‡ºé…ç½®å€¼ï¼Œé‚£ä¹ˆConsumerå°±ä¼šè‡ªåŠ¨é€€ç»„</li>
<li><code>session.timout.ms</code>ï¼šå­˜æ´»æ—¶é—´é—´éš”ï¼Œé»˜è®¤10sã€‚è¡¨æ˜å¦‚æœ10så†…æ²¡æœ‰ä»»ä½•å¿ƒè·³è¯·æ±‚ï¼ŒCoordinatorå°±åˆ¤æ–­Consumerå·²ç»é€€å‡º</li>
</ul>
<p>æ¨èé…ç½®ï¼š</p>
<p><code>session.timeout.ms = 6s</code></p>
<p><code> heartbeat.interval.ms = 2s</code></p>
<p><code>max.poll.interval.ms</code>è®¾ç½®ä¸ºä¸šåŠ¡é€»è¾‘å¤„ç†æœ€é•¿æ—¶é—´</p>
</li>
</ol>
<h6 id="Rebalanceè¦ç‚¹"><a href="#Rebalanceè¦ç‚¹" class="headerlink" title="Rebalanceè¦ç‚¹"></a>Rebalanceè¦ç‚¹</h6><ul>
<li><p>é€šçŸ¥æœºåˆ¶</p>
<p>å½“å‘ç”ŸRebalanceæ—¶ï¼ŒCoordinatorå°†â€REBALANCE_IN_PROGRESSâ€œå°è£…è¿›å¿ƒè·³è¯·æ±‚å“åº”é‡Œé¢ï¼ŒConsumerä¹Ÿå› æ­¤çŸ¥é“äº†é‡å¹³è¡¡é©¬ä¸Šå°±è¦å¼€å§‹äº†</p>
</li>
<li><p>Consumer GroupçŠ¶æ€æœº</p>
<p>Kafkaä¸ºæ¶ˆè´¹ç»„å®šä¹‰äº†5ç§çŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303190703.png" loading="lazy"></p>
<p>çŠ¶æ€æœºæµè½¬å¦‚ä¸‹</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303190823.png" loading="lazy"></p>
<p>ä¸€ä¸ªæ¶ˆè´¹è€…ç»„æœ€å¼€å§‹æ˜¯ Empty çŠ¶æ€ï¼Œå½“é‡å¹³è¡¡è¿‡ç¨‹å¼€å¯åï¼Œå®ƒä¼šè¢«ç½®äº PreparingRebalance çŠ¶æ€ç­‰å¾…æˆå‘˜åŠ å…¥ï¼Œä¹‹åå˜æ›´åˆ° CompletingRebalance çŠ¶æ€ç­‰å¾…åˆ†é…æ–¹æ¡ˆï¼Œæœ€åæµè½¬åˆ° Stable çŠ¶æ€å®Œæˆé‡å¹³è¡¡</p>
<p>å¦‚æœç»„åœ¨EmptyçŠ¶æ€ä¸‹çš„å­˜åœ¨å¾ˆé•¿æ—¶é—´ï¼ˆæ•´ä¸ªç»„åœæ‰é•¿æ—¶é—´ä¸åœ¨æ¶ˆè´¹ï¼‰ï¼Œä½ç§»æ•°æ®å¯èƒ½ä¼šè¢«åˆ é™¤</p>
</li>
</ul>
<h6 id="Consumeré‡å¹³è¡¡æ­¥éª¤"><a href="#Consumeré‡å¹³è¡¡æ­¥éª¤" class="headerlink" title="Consumeré‡å¹³è¡¡æ­¥éª¤"></a>Consumeré‡å¹³è¡¡æ­¥éª¤</h6><ol>
<li><p>åŠ å…¥ç»„ï¼ˆJoinGroupè¯·æ±‚ï¼‰</p>
<p>æ¯ä¸ªç»„å‘˜éƒ½ä¼šå°†è‡ªå·±è®¢é˜…ä¿¡æ¯ä¸ŠæŠ¥ï¼ŒCoordinatorä¼šä»ç»„å‘˜ä¸­é€‰å‡ºLeader Consumerï¼Œä¸€èˆ¬çš„ç¬¬ä¸€ä¸ªè¯·æ±‚è€…ã€‚é€‰ä¸¾å®Œåä¼šå°†æ‰€æœ‰çš„è®¢é˜…ä¿¡æ¯å‘é€çš„Leaders Consumerï¼Œç”±å…¶åˆ¶å®šåˆ†é…</p>
</li>
<li><p>ç­‰å¾…Leader Consumersåˆ†é…æ–¹æ¡ˆï¼ˆSyncGroupè¯·æ±‚ï¼‰</p>
<p>Leaders Consumerå®Œæˆåˆ†é…æ–¹æ¡ˆåå‘Coordinateå‘é€SyncGroupè¯·æ±‚ï¼ŒåŒæ—¶å…¶ä»–ç»„å‘˜ä¹Ÿä¼šå‘é€SyncGroupè¯·æ±‚ï¼Œä½†æ²¡æœ‰å®é™…å†…å®¹ã€‚æœ€åç»Ÿä¸€ä»¥å“åº”çš„æ–¹å¼åˆ†å‘ç»™æ‰€æœ‰ç»„å‘˜</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303192421.png" loading="lazy"></p>
<center>JoinGroupè¯·æ±‚</center>

<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303192537.png" loading="lazy"></p>
<center>SyncGroupè¯·æ±‚</center>



<h5 id="ä½ç§»æäº¤"><a href="#ä½ç§»æäº¤" class="headerlink" title="ä½ç§»æäº¤"></a>ä½ç§»æäº¤</h5><p><strong>Consumeréœ€è¦ä¸ºåˆ†é…ç»™å®ƒçš„æ¯ä¸ªåˆ†åŒºæäº¤å„è‡ªçš„ä½ç§»æ•°æ®</strong>ï¼Œç”¨æ¥è¡¨ç¤ºæ¶ˆè´¹è¿›åº¦ã€‚æ¯”å¦‚æäº¤ä½ç§»è¿›åº¦Xè¡¨ç¤ºXä»¥ä¸‹éƒ½å·²ç»è¢«æ¶ˆè´¹</p>
<p>æäº¤æ–¹å¼ï¼š</p>
<ol>
<li><p>è‡ªåŠ¨æäº¤</p>
<p>è‡ªåŠ¨æäº¤ä¿è¯at least oneï¼Œè¿™å°±æ„å‘³ç€å¯èƒ½å­˜åœ¨æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Œæ¯”å¦‚Consumer æ­£åœ¨æ¶ˆè´¹æ—¶å®•æœºäº†ï¼Œäº§ç”Ÿäº†Rebalanceï¼Œåˆ†é…å®Œåå…¶ä»–Consumerä¼šä»å®ƒæ¶ˆè´¹çš„æ‰€æœ‰Partitionçš„æœ€è¿‘ä¸€æ¬¡æäº¤ä½ç§»å¤„å¼€å§‹æ¶ˆè´¹ï¼Œä»è€Œå¯¼è‡´é‡å¤æ¶ˆè´¹</p>
<blockquote>
<p>By default, the consumer is configured to auto-commit offsets. Using auto-commit gives you â€œat least onceâ€ delivery: Kafka guarantees that no messages will be missed, but duplicates are possible. Auto-commit basically works as a cron with a period set through the <code>auto.commit.interval.ms</code> configuration property. If the consumer crashes, then after a restart or a rebalance, the position of all partitions owned by the crashed consumer will be reset to the last committed offset. When this happens, the last committed position may be as old as the auto-commit interval itself. Any messages which have arrived since the last commit will have to be read again. <a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/clients/consumer.html#ak-consumer-configuration">consumer doc</a></p>
</blockquote>
<p>é€šè¿‡<code> enable.auto.commit</code>è®¾ç½®æ˜¯å¦å¼€å¯ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„</p>
<p><code>auto.commit.interval.ms</code>è¡¨ç¤ºè‡ªåŠ¨æäº¤é—´éš”ï¼Œé»˜è®¤å€¼ä¸º5s</p>
<p>è‡ªåŠ¨æäº¤é€»è¾‘æ˜¯åœ¨pollæ–¹æ³•é‡Œé¢æ‰§è¡Œçš„ï¼Œæ¯æ¬¡pollçš„æ—¶å€™éƒ½ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦è‡ªåŠ¨æäº¤ï¼Œå¤§æ¦‚é€»è¾‘å¦‚ä¸‹</p>
<pre><code>ç¬¬ä¸€æ¬¡poll        è®¾ç½®æäº¤æ—¶é—´ä¸º5så
    +10s 
ç¬¬äºŒæ¬¡poll        ä¸¤æ¬¡pollé—´éš”ä¸º10sï¼Œæ¯”5så¤§å°±è‡ªåŠ¨æäº¤ï¼Œç„¶åè®¾ç½®ä¸‹æ¬¡æäº¤æ—¶é—´ä¸º15s</code></pre>
</li>
<li><p>æ‰‹åŠ¨æäº¤</p>
<p>å°†<code>enable.auto.commit</code>è®¾ç½®ä¸ºfalseå³å¯ï¼ŒKafkaæä¾›åŒæ­¥å’Œå¼‚æ­¥æäº¤ä¸¤ç§æ–¹å¼</p>
<ul>
<li><p>åŒæ­¥æäº¤</p>
<p>ä½¿ç”¨KafkaConsumer#commitSyncæ–¹æ³•ï¼Œæä¾›é‡è¯•æœºåˆ¶ï¼ŒåŒæ­¥æäº¤ä¼šå½±å“TPS</p>
</li>
<li><p>å¼‚æ­¥æäº¤</p>
<p>ä½¿ç”¨ KafkaConsumer#commitAsync()æ–¹æ³•ï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶ï¼Œå¼‚æ­¥æ–¹å¼é‡è¯•æœºåˆ¶æ˜¯æ²¡æœ‰æ„ä¹‰çš„</p>
<p>å¼‚æ­¥æäº¤å¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼ŒKafkaæä¾›å›è°ƒå‡½æ•°ï¼Œå¯ä»¥é€šè¿‡å›è°ƒå‡½æ•°æ—¶è¿›è¡Œå¤±è´¥é€»è¾‘å¤„ç†</p>
</li>
</ul>
<p>å°†åŒæ­¥æäº¤å’Œå¼‚æ­¥æäº¤ç»“åˆ</p>
<pre><code class="java">try&#123;
    while (true) &#123;
        ConsumerRecords&lt;String, String&gt; records = 
        consumer.poll(Duration.ofSeconds(1));
         process(records); // å¤„ç†æ¶ˆæ¯
         commitAysnc(); // ä½¿ç”¨å¼‚æ­¥æäº¤è§„é¿é˜»å¡
     &#125;
&#125; catch (Exception e) &#123;
     handle(e); // å¤„ç†å¼‚å¸¸
&#125; finally &#123;
     try &#123;
         consumer.commitSync(); // æœ€åä¸€æ¬¡æäº¤ä½¿ç”¨åŒæ­¥é˜»å¡å¼æäº¤
    &#125; finally &#123;
         consumer.close();
    &#125;
&#125;</code></pre>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>commitSync(final Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets)</code>åŠ<code>commitAsync(final Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets, OffsetCommitCallback callback)</code>è¿›è¡Œå°æ‰¹é‡æäº¤ï¼Œæ¯”å¦‚æ¯æ¶ˆè´¹ä¸€ç™¾æ¡æäº¤ä¸€æ¬¡</p>
<pre><code class="java">
private Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets = new HashMap&lt;&gt;();
int count = 0;
â€¦â€¦
while (true) &#123;
     ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofSeconds(1));
     for (ConsumerRecord&lt;String, String&gt; record: records) &#123;
         process(record); // å¤„ç†æ¶ˆæ¯
         offsets.put(new TopicPartition(record.topic(), record.partition()),
         new OffsetAndMetadata(record.offset() + 1)ï¼›
         ifï¼ˆcount % 100 == 0ï¼‰
             consumer.commitAsync(offsets, null); // å›è°ƒå¤„ç†é€»è¾‘æ˜¯ n
         count++;
    &#125;
&#125;</code></pre>
</li>
</ol>
<p>è‡ªåŠ¨æäº¤å’Œæ‰‹åŠ¨æäº¤éƒ½æ— æ³•é¿å…æ¶ˆæ¯é‡å¤æ¶ˆæ¯é—®é¢˜ï¼Œéœ€è¦åœ¨ä¸šåŠ¡ä¸Šåšå»é‡</p>
<h5 id="Consumerå»ºç«‹TCPè¿æ¥ç§ç±»"><a href="#Consumerå»ºç«‹TCPè¿æ¥ç§ç±»" class="headerlink" title="Consumerå»ºç«‹TCPè¿æ¥ç§ç±»"></a>Consumerå»ºç«‹TCPè¿æ¥ç§ç±»</h5><p>æœ‰3ç±»TCPè¿æ¥</p>
<ol>
<li><p>å‘èµ· FindCoordinator è¯·æ±‚æ—¶ï¼ˆç¬¬ä¸€ç±»ï¼‰</p>
<p>åˆ›å»ºTCPè¿æ¥ï¼Œå‘é€FindCoordinatorè¯·æ±‚åˆ°<code>bootstrap.servers</code>çš„ä»»æ„æœåŠ¡å™¨ï¼Œå¾—åˆ°ç®¡ç†å®ƒçš„Brokerå…ƒæ•°æ®</p>
</li>
<li><p>è¿æ¥Coordinatorï¼ˆç¬¬äºŒç±»ï¼‰</p>
<p>åˆ›å»ºä¸Coordinatorçš„TCPè¿æ¥ï¼Œè¿™æ ·æ‰èƒ½å¼€å¯ç»„åè°ƒæ“ä½œ</p>
</li>
<li><p>æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼ˆç¬¬ä¸‰ç±»ï¼‰</p>
<p>Consumerä¸ºæ¯ä¸ªè¦æ¶ˆè´¹çš„åˆ†åŒºåˆ›å»ºäºè¯¥åˆ†åŒºé¢†å¯¼è€…å‰¯æœ¬æ‰€åœ¨çš„Brokerè¿æ¥çš„TCP</p>
</li>
</ol>
<p>å½“ç¬¬ä¸‰ç±»è¿æ¥å»ºç«‹æ—¶ï¼ŒConsumerä¼škillæ‰ç¬¬ä¸€ç±»TCPè¿æ¥</p>
<h5 id="æ¶ˆè´¹è¿›åº¦ç›‘æ§"><a href="#æ¶ˆè´¹è¿›åº¦ç›‘æ§" class="headerlink" title="æ¶ˆè´¹è¿›åº¦ç›‘æ§"></a>æ¶ˆè´¹è¿›åº¦ç›‘æ§</h5><ul>
<li>Lagï¼šè¡¨ç¤ºæ¶ˆè´¹æ¶ˆæ¯è½åç”Ÿäº§æ¶ˆæ¯ç¨‹åº¦ï¼Œæ¯”å¦‚äº§ç”Ÿäº†100ä¸‡æ¡æ¶ˆæ¯ï¼Œå½“å‰æ¶ˆè´¹äº†80ä¸‡æ¡ï¼Œé‚£ä¹ˆæ¶ˆæ¯æ»åäº†20ä¸‡æ¡ï¼Œå³Lag=20w</li>
<li>Leadï¼šè¡¨ç¤ºæœ€æ–°æ¶ˆè´¹æ¶ˆæ¯çš„ä½ç§»å’Œåˆ†åŒºç¬¬ä¸€æ¡ä½ç§»çš„å·®å€¼ï¼Œæ¯”å¦‚å½“å‰æ¶ˆè´¹ä½ç§»ä¸º5ï¼Œç¬¬ä¸€æ¡ä½ç§»ä¸º0ï¼Œé‚£ä¹ˆLead=5</li>
</ul>
<p>ä½¿ç”¨JMXç›‘æ§</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303160430.png" alt="image-20230303160423390" loading="lazy"></p>
<h4 id="å‰¯æœ¬æœºåˆ¶"><a href="#å‰¯æœ¬æœºåˆ¶" class="headerlink" title="å‰¯æœ¬æœºåˆ¶"></a>å‰¯æœ¬æœºåˆ¶</h4><p> Kafkaé‡‡ç”¨äº†åŸºäºé¢†å¯¼è€…çš„ï¼ˆLeader-basedï¼‰çš„å‰¯æœ¬æœºåˆ¶ã€‚</p>
<ol>
<li>å‰¯æœ¬åˆ†ä¸ºLeaderå’ŒFollowerå‰¯æœ¬ï¼ŒFollowerä¼šè‡ªåŠ¨è¿½éšLeader</li>
<li>åªæœ‰Leaderå¯¹å¤–æä¾›æœåŠ¡ï¼ŒFollowerä»Leaderå¼‚æ­¥æ‹‰å–æ¶ˆæ¯</li>
<li>å¦‚æœLeaderæŒ‚äº†ï¼ŒKafkaä¼šè¿›è¡Œé‡æ–°é€‰ä¸¾</li>
</ol>
<h5 id="In-sync-Replicasï¼ˆISRï¼‰"><a href="#In-sync-Replicasï¼ˆISRï¼‰" class="headerlink" title="In-sync Replicasï¼ˆISRï¼‰"></a>In-sync Replicasï¼ˆISRï¼‰</h5><p>ä¸Leaderä¿æŒåŒæ­¥çš„å‰¯æœ¬ç§°ä¸ºISRï¼Œæ˜¯å¦ä¿æŒåŒæ­¥çš„æ ‡å‡†å°±æ˜¯Broker ç«¯å‚æ•° <code>replica.lag.time.max.ms </code>å‚æ•°å€¼ï¼Œé»˜è®¤10sã€‚å®ƒè¡¨ç¤ºçš„æ˜¯Followerèƒ½å¤Ÿè½åLeaderçš„æœ€é•¿æ—¶é—´</p>
<p>Kafkaåœ¨å¯åŠ¨æ—¶ä¼šå¼€å¯ä¸¤ä¸ªä»»åŠ¡ï¼Œä¸€æ˜¯å®šæœŸæ£€æŸ¥æ˜¯å¦éœ€è¦ç¼©å‡æˆ–æ‰©å¤§ISRé›†åˆï¼Œå‘¨æœŸæ˜¯<code>æ˜¯replica.lag.time.max.ms</code>ä¸€åŠï¼›äºŒæ˜¯å®šæœŸæ£€æŸ¥isrChangeSetï¼ˆç¼“å­˜ISRå˜æ›´è®°å½•é›†åˆï¼‰ï¼Œå¦‚æœSetæœ‰å˜æ›´è®°å½•ï¼Œé‚£ä¹ˆä¼šåœ¨zkä¸­æŒä¹…åŒ–ä¸€ä¸ªèŠ‚ç‚¹ ã€‚controllerèŠ‚ç‚¹æ³¨å†Œçš„watcherèƒ½æ„ŸçŸ¥åˆ°ISRçš„å˜åŒ–ç„¶åå‘å®ƒæ‰€ç®¡ç†çš„BrokerèŠ‚ç‚¹å‘é€æ›´æ–°å…ƒæ•°æ®è¯·æ±‚ï¼Œæœ€ååˆ é™¤å¤„ç†è¿‡çš„èŠ‚ç‚¹</p>
<ul>
<li><p>è¸¢å‡ºISR</p>
<p>å¦‚æœFolloweråœ¨è¶…å‡ºäº†<code>replica.lag.time.max.ms</code>æ—¶é—´åè¿˜å‡ºäºè½åçŠ¶æ€ï¼Œé‚£å°±ä¼šè¢«è¸¢å‡ºISRã€‚</p>
</li>
<li><p>è¿›å…¥ISR</p>
<p>å½“æ£€æŸ¥åˆ°Followerçš„High Watermarkè¿½èµ¶ä¸ŠLeaderæ—¶å°±æ‰©å……ISR</p>
</li>
</ul>
<h5 id="Unclean-Leader-Election"><a href="#Unclean-Leader-Election" class="headerlink" title="Unclean Leader Election"></a>Unclean Leader Election</h5><p>Unclean Leader ElectionæŒ‡çš„æ˜¯å½“ISRä¸ºç©ºï¼ˆLeaderä¹Ÿä¸åœ¨äº†ï¼‰æ—¶ï¼Œæ˜¯å¦å…è®¸Kafkaåœ¨éåŒæ­¥å‰¯æœ¬ä¸­é€‰ä¸¾æ–°çš„Leaderï¼Œå¦‚æœä¸å…è®¸ï¼Œé‚£ä¹ˆåˆ†åŒºå°±å¤±æ•ˆäº†ã€‚</p>
<p>é€šè¿‡Broker ç«¯å‚æ•° <code>unclean.leader.election.enable</code>æ§åˆ¶æ˜¯å¦å¼€å¯</p>
<p>å¼€å¯é€‰é¡¹å¯èƒ½ä¼šé€ æˆæ•°æ®ä¸¢å¤«ï¼Œå¥½å¤„åœ¨äºæé«˜äº†å¯ç”¨æ€§</p>
<h5 id="High-Watermark-HW"><a href="#High-Watermark-HW" class="headerlink" title="High Watermark(HW)"></a>High Watermark(HW)</h5><p>Kafkaç”¨High Watermarkæ¥è¡¨å¾æ¶ˆæ¯ä½ç§»ï¼Œæœ‰ä»¥ä¸‹ä½œç”¨</p>
<ul>
<li>å®šä¹‰æ¶ˆæ¯å¯è§æ€§ï¼Œå³åˆ†åŒºå“ªäº›æ¶ˆæ¯å¯è¢«æ¶ˆè´¹</li>
<li>å¸®åŠ©Kafkaå®Œæˆå‰¯æœ¬åŒæ­¥</li>
</ul>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230305165243.png" loading="lazy"></p>
<p>åŒä¸€ä¸ªå‰¯æœ¬å¯¹è±¡ï¼Œå…¶é«˜ æ°´ä½å€¼ä¸ä¼šå¤§äº LEOï¼ˆLog End Offset) å€¼</p>
<h6 id="æ›´æ–°æœºåˆ¶"><a href="#æ›´æ–°æœºåˆ¶" class="headerlink" title="æ›´æ–°æœºåˆ¶"></a>æ›´æ–°æœºåˆ¶</h6><p><img src="https://raw.githubusercontent.com/soda1/img/main/20230305165811.png" loading="lazy"></p>
<p>æ¯ä¸ªå‰¯æœ¬éƒ½ä¼šä¿å­˜HWå’ŒLEOä¸¤ä¸ªå±æ€§ï¼Œè€ŒLeaderæ‰€åœ¨çš„Brokerä¹Ÿä¼šä¿å­˜æ‰€æœ‰Followerçš„å‰¯æœ¬ï¼Œç”¨äºå¸®åŠ©Leaderç¡®å®šå…¶HWã€‚</p>
<p><strong>Leaderä¸‹æ›´æ–°é€»è¾‘</strong></p>
<p>å¤„ç†Produceræ¶ˆæ¯</p>
<ol>
<li>æ¶ˆæ¯å†™å…¥ç£ç›˜</li>
<li>æ›´æ–°åˆ†åŒºHW<ol>
<li>è·å–Leaderæ‰€åœ¨Brokerä¿å­˜çš„Followersçš„LEOå€¼{LEO-1ï¼ŒLEO-2â€¦}</li>
<li>æ›´æ–°HW=min(leader-LEO, LEO-1, LEO-2â€¦..)</li>
</ol>
</li>
</ol>
<p>å¤„ç†Followeræ‹‰å–æ¶ˆæ¯</p>
<ol>
<li>æ ¹æ®Followerå‘é€æ¥çš„LEOè¯»å–æ¶ˆæ¯æ•°æ®</li>
<li>å°†Followerå‘é€æ¥çš„LEOæ›´æ–°åˆ°Brokerä¿å­˜çš„å¯¹åº”å‰¯æœ¬ä¸­</li>
<li>æ›´æ–°åˆ†åŒºHWï¼ˆåŒä¸Šï¼‰</li>
</ol>
<p><strong>Followerä¸‹æ›´æ–°é€»è¾‘</strong></p>
<p>ä»Leaderå¤„æ‹‰å–æ¶ˆæ¯ï¼š</p>
<ol>
<li>å°†æ¶ˆæ¯å†™å…¥ç£ç›˜</li>
<li>æ›´æ–°LEO</li>
<li>æ›´æ–°HW<ol>
<li>è·å–Leaderå‘é€æ¥çš„leader-LEO</li>
<li>è·å–æ›´æ–°è¿‡çš„currentLEO</li>
<li>æ›´æ–°é«˜æ°´ä½ä¸ºmin(leader-LEO, currentLEO)</li>
</ol>
</li>
</ol>
<p><strong>æ›´æ–°å­˜åœ¨é—®é¢˜</strong></p>
<p>HWçš„æ›´æ–°é€šå¸¸éœ€è¦é¢å¤–ä¸€è½®çš„æ‹‰å–è¯·æ±‚æ‰èƒ½å®Œæˆï¼Œå®¹æ˜“å¼•å‘ä»¥ä¸‹é—®é¢˜</p>
<ul>
<li><p>å¤‡ä»½æ•°æ®ä¸¢å¤±</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230305172705.png" loading="lazy"></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“Aæ›´æ–°å®ŒHWåï¼ŒBè¿˜æœªæ¥å¾—åŠæ›´æ–°å°±å®•æœºäº†ï¼Œé‡å¯åHWè¿˜æ˜¯ä¸º1ï¼Œæ­¤æ—¶å‘Aå‘é€Fetchè¯·æ±‚ï¼Œå¦‚æœAæ°å¥½åˆå®•æœºäº†ï¼Œé‚£ä¹ˆBå°±ä¼šæˆä¸ºLeaderï¼Œåé¢Aé‡å¯åå‘Bå‘é€Fetchè¯·æ±‚ï¼ŒHWå°†æ›´æ–°ä¸º1ï¼Œä»è€Œä¸¢å¤±æ•°æ®</p>
</li>
<li><p>å¤‡ä»½æ•°æ®ä¸ä¸€è‡´</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230305235446.png" loading="lazy"></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“Açš„HW=2 å’ŒBçš„HW=1æ—¶åŒæ—¶å‘ç”Ÿäº†å®•æœºï¼ŒBé‡å¯åæˆä¸ºäº†Leaderï¼Œæ­¤æ—¶Producerå‘é€äº†æ¶ˆæ¯ç»™Bï¼ŒBå°±ä¼šè¦†ç›–æ¶ˆæ¯2ä¸”HWä¹Ÿä¼šæ›´æ–°ä¸º2ï¼Œåé¢Aé‡å¯å›æ¥ä¼šæ‰§è¡Œæ—¥å¿—æˆªæ–­ï¼Œä½†å‘ç°åˆ†åŒºçš„HWå’Œè‡ªå·±çš„HWéƒ½æ˜¯2ï¼Œæ•…ä¸ä½œä»»ä½•è°ƒæ•´ï¼Œä»è€Œå¼•èµ·æ•°æ®ä¸ä¸€è‡´</p>
<p><strong>leader epoch</strong></p>
<p>Kafkaä»0.11å¼•å…¥leader epochï¼Œä»è€Œè§„é¿ä»¥ä¸Šé—®é¢˜ã€‚leader epochå®é™…æ˜¯ä¸€å¯¹å€¼ï¼ˆepochï¼Œ offsetï¼‰ï¼Œepochè¡¨ç¤ºç‰ˆæœ¬å·ï¼Œä»0å¼€å§‹ï¼Œæ¯å½“leaderè§’è‰²å‘ç”Ÿå˜æ›´å°±+1ï¼Œoffsetè¡¨ç¤ºå†™å…¥è¯¥epochçš„ç¬¬ä¸€æ¡æ¶ˆæ¯ä½ç§»ã€‚</p>
<p>Kafka Broker ä¼šåœ¨å†…å­˜ä¸­ä¸ºæ¯ä¸ªåˆ†åŒºéƒ½ç¼“å­˜  epoch æ•°æ®ï¼ŒåŒæ—¶å®ƒè¿˜å°†è¿™äº› ä¿¡æ¯æŒä¹…åŒ–åˆ°ä¸€ä¸ª checkpoint æ–‡ä»¶ä¸­ã€‚å¦‚æœLeader æ˜¯é¦–æ¬¡å†™å…¥æ¶ˆæ¯ï¼Œé‚£ä¹ˆBrokerä¼šå‘ç¼“å­˜ä¸­å¢åŠ ä¸€ä¸ª epoch æ¡ç›®ï¼Œå¦åˆ™å°±ä¸åšæ›´æ–°ã€‚</p>
<p>è§£å†³æ•°æ®ä¸¢å¤±</p>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230306010801.png" loading="lazy"></p>
<p>å‰¯æœ¬Bé‡å¯åå‘Aå‘é€LeaderEpochRequestè·å–Açš„LEOå€¼ï¼Œå‘ç°Açš„LEOä¸æ¯”è‡ªå·±çš„å°ï¼Œä¸”epochä¸­çš„offsetä¹Ÿæ²¡æœ‰æ¯”2å¤§ï¼Œå› æ­¤æ— éœ€æ‰§è¡Œä»»ä½•æ—¥å¿—æˆªæ–­</p>
<p>å½“Bæˆä¸ºLeaderæ—¶,[epoch = 1, offset = 3],Aé‡å¯åä¼šå‘Bå‘é€LeaderEpochRequestå»è·å–Leaderçš„LEOå€¼ï¼Œå‘ç°å…¶LEOæ¯”Bçš„å°ä¸”epochä¸­çš„offsetä¹Ÿæ²¡æœ‰æ¯”3å¤§ï¼Œå› æ­¤ä¹Ÿæ— éœ€æˆªæ–­</p>
<p>æ³¨æ„åªæœ‰Followeræ‰ä¼šæ‰§è¡Œæ—¥å¿—æˆªæ–­ï¼ŒLeaderæ˜¯ä¸ä¼šæ‰§è¡Œæ—¥å¿—æˆªæ–­çš„</p>
</li>
</ul>
<h4 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h4><p><img src="https://raw.githubusercontent.com/soda1/img/main/20230306151424.png" loading="lazy"></p>
<p>todoï¼šå¤–ç½‘æš‚æœªæ‰¾åˆ°ç›¸å…³èµ„æ–™</p>
<h5 id="Brokerç½‘ç»œæ¨¡å‹"><a href="#Brokerç½‘ç»œæ¨¡å‹" class="headerlink" title="Brokerç½‘ç»œæ¨¡å‹"></a>Brokerç½‘ç»œæ¨¡å‹</h5><p>Brokerç½‘ç»œå±‚é‡‡ç”¨äº†Reactoræ¨¡å¼ï¼Œæœ‰ä¸ªæ ¸å¿ƒç»„ä»¶SocketServerï¼Œçº¿ç¨‹æ¨¡å‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸€ä¸ªAcceptorçº¿ç¨‹æ¥æ”¶è¯·æ±‚</li>
<li>Nä¸ªProcessorçº¿ç¨‹,æ¯ä¸ªProcessoréƒ½æœ‰è‡ªå·±çš„selector,ä»æ¯ä¸ªè¿æ¥ä¸­è¯»å–è¯·æ±‚</li>
<li>Mä¸ªHandlerçº¿ç¨‹å¤„ç†è¯·æ±‚,å¹¶å°†äº§ç”Ÿçš„è¯·æ±‚è¿”å›ç»™Processorçº¿ç¨‹ç”¨äºå†™å›å®¢æˆ·ç«¯</li>
</ul>
<p><img src="https://raw.githubusercontent.com/soda1/img/main/20230303184103.png" loading="lazy"></p>
<h4 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h4><p>æ§åˆ¶å™¨ç»„ä»¶ï¼ˆControllerï¼‰æ˜¯ Apache Kafka çš„æ ¸å¿ƒç»„ä»¶ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ Apache ZooKeeper çš„å¸®åŠ©ä¸‹ç®¡ç†å’Œåè°ƒæ•´ä¸ª Kafka é›†ç¾¤ã€‚Kafkaé›†ç¾¤é€šè¿‡é€‰ä¸¾é€‰å‡ºControllerã€‚JMXæŒ‡æ ‡ä¸º<code>activeController</code></p>
<h5 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h5><ol>
<li><p>ä¸»é¢˜ç®¡ç†ï¼ˆåˆ›å»ºã€åˆ é™¤ã€å¢åŠ åˆ†åŒºï¼‰</p>
</li>
<li><p>åˆ†åŒºé‡åˆ†é…</p>
</li>
<li><p>.Preferred é¢†å¯¼è€…é€‰ä¸¾</p>
<p>Preferredé€‰ä¸¾æ˜¯Kafkaä¸ºäº†é¿å…éƒ¨åˆ†Brokerè´Ÿè½½è¿‡é‡è€Œæä¾›çš„ä¸€ç§æ¢Leaderæ–¹æ¡ˆ</p>
</li>
<li><p>é›†ç¾¤æˆå‘˜ç®¡ç†ï¼ˆæ–°å¢ Brokerã€Broker ä¸»åŠ¨å…³é—­ã€Broker å®•æœºï¼‰</p>
</li>
<li><p>æ•°æ®æœåŠ¡ï¼ˆé›†ç¾¤å…ƒæ•°æ®ä¿¡æ¯ï¼‰</p>
<p>Controllerä¼šæœ‰æ•´ä¸ªé›†ç¾¤æœ€å®Œæ•´çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ŒZookeeperä¹Ÿä¼šä¿å­˜ä¸€ä»½ï¼ŒControllerçš„åˆå§‹åŒ–å…ƒæ•°æ®ä¿¡æ¯ç”±Zookeeperæä¾›</p>
</li>
</ol>
<h5 id="å¦‚ä½•é€‰ä¸¾"><a href="#å¦‚ä½•é€‰ä¸¾" class="headerlink" title="å¦‚ä½•é€‰ä¸¾"></a>å¦‚ä½•é€‰ä¸¾</h5><p>å½“Brokerå¯åŠ¨æ—¶ï¼Œä¼šå°è¯•åœ¨Zookeeperä¸­/controllerèŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªåˆ›å»ºæˆåŠŸçš„Brokerä¼šè¢«é€‰ä¸¾ä¸ºController</p>
<h5 id="å¤±æ•ˆå¤„ç†"><a href="#å¤±æ•ˆå¤„ç†" class="headerlink" title="å¤±æ•ˆå¤„ç†"></a>å¤±æ•ˆå¤„ç†</h5><p>å½“Controlleræ‰€åœ¨çš„Brokerå‡ºç°å¼‚å¸¸é€€å‡ºäº†é›†ç¾¤ï¼ŒZookeeperé€šè¿‡Watchæœºåˆ¶æ„Ÿåº”å¹¶å°†/controllerèŠ‚ç‚¹åˆ é™¤ï¼Œä¹‹åå­˜æ´»çš„Brokerä¼šå¼€å§‹è¿›è¡Œé€‰ä¸¾ï¼Œé€‰ä¸¾æˆåŠŸçš„Brokerä¼šä»Zookeeperä¸­è¯»å–å…ƒæ•°æ®ä¿¡æ¯ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<h5 id="å†…éƒ¨è®¾è®¡ç»“æ„"><a href="#å†…éƒ¨è®¾è®¡ç»“æ„" class="headerlink" title="å†…éƒ¨è®¾è®¡ç»“æ„"></a>å†…éƒ¨è®¾è®¡ç»“æ„</h5><p><img src="https://raw.githubusercontent.com/soda1/img/main/20230304145246.png" loading="lazy"></p>
<h4 id="åŠ¨æ€Brokerå‚æ•°"><a href="#åŠ¨æ€Brokerå‚æ•°" class="headerlink" title="åŠ¨æ€Brokerå‚æ•°"></a>åŠ¨æ€Brokerå‚æ•°</h4><p>ä»1.1ç‰ˆæœ¬å¼€å§‹ï¼Œ Brokers Configså¢åŠ Update Modelåˆ—ï¼Œæœ‰ä¸‰ç±»å€¼</p>
<ul>
<li>read-olnyï¼šè¡¨ç¤ºä¿®æ”¹åªèƒ½é‡å¯Brokeråæ‰èƒ½ç”Ÿæ•ˆ</li>
<li>per-broker: å±äºåŠ¨æ€å‚æ•°ï¼Œä¿®æ”¹ååªåœ¨å¯¹åº”Brokerä¸Šç”Ÿæ•ˆ</li>
<li>cluster-wideï¼šå±äºåŠ¨æ€å‚æ•°ï¼Œä¿®æ”¹åæ•´ä¸ªé›†ç¾¤ç”Ÿæ•ˆ</li>
</ul>
<p><del>ä¼˜å…ˆçº§åˆ«ï¼š per-broker &gt; cluster-wide &gt; read-only&gt; Kafkaé»˜è®¤å€¼</del></p>
<p><strong>ä½¿ç”¨åœºæ™¯</strong></p>
<ul>
<li>åŠ¨æ€è°ƒæ•´ Broker ç«¯å„ç§çº¿ç¨‹æ± å¤§å°ï¼Œå®æ—¶åº”å¯¹çªå‘æµé‡</li>
<li> åŠ¨æ€è°ƒæ•´ Broker ç«¯è¿æ¥ä¿¡æ¯æˆ–å®‰å…¨é…ç½®ä¿¡æ¯</li>
<li> åŠ¨æ€æ›´æ–° SSL Keystore æœ‰æ•ˆæœŸ</li>
<li> åŠ¨æ€è°ƒæ•´ Broker ç«¯ Compact æ“ä½œæ€§èƒ½</li>
<li> å®æ—¶å˜æ›´ JMX æŒ‡æ ‡æ”¶é›†å™¨ (JMX Metrics Reporter)</li>
</ul>
<p><strong>å¦‚ä½•é…ç½®</strong></p>
<p>ä½¿ç”¨kafka-config.sh</p>
<h4 id="é‡è®¾æ¶ˆè´¹ç»„ä½ç§»"><a href="#é‡è®¾æ¶ˆè´¹ç»„ä½ç§»" class="headerlink" title="é‡è®¾æ¶ˆè´¹ç»„ä½ç§»"></a>é‡è®¾æ¶ˆè´¹ç»„ä½ç§»</h4><p><strong>ç­–ç•¥</strong></p>
<ul>
<li>Earliestï¼šæŠŠä½ç§»è°ƒæ•´åˆ°å½“å‰æœ€æ—©ä½ç§»å¤„</li>
<li>Latestï¼šæŠŠä½ç§»è°ƒæ•´åˆ°å½“å‰æœ€æ–°ä½ç§»å¤„</li>
<li>Currentï¼šæŠŠä½ç§»è°ƒæ•´åˆ°å½“å‰æœ€æ–°æäº¤ä½ç§»å¤„</li>
<li>Specified-Offsetï¼šæŠŠä½ç§»è°ƒæ•´åˆ°æŒ‡å®šä½ç§»å¤„</li>
<li>Shift-By-Nï¼šæŠŠä½ç§»è°ƒæ•´åˆ°å½“å‰ä½ç§» +Nå¤„ï¼ˆNå¯ä¸ºè´Ÿå€¼ï¼‰</li>
<li>DateTimeï¼šæŠŠä½ç§»è°ƒæ•´åˆ°å¤§äºç»™å®šæ—¶é—´çš„æœ€å°ä½ç§»å¤„</li>
<li>Durationï¼šæŠŠä½ç§»è°ƒæ•´åˆ°è·ç¦»å½“å‰æ—¶é—´æŒ‡å®šé—´éš”ä½ç§»å¤„</li>
</ul>
<p><strong>æ–¹æ³•</strong></p>
<ul>
<li>é€šè¿‡Java APIé‡è®¾ä½ç§»ï¼šè°ƒç”¨KafkaConsumerçš„seekæ–¹æ³•ï¼Œæˆ–è€…å®ƒçš„å˜ç§æ–¹æ³•seekToBeginningå’ŒseekToEnd</li>
<li>ç”¨è„šæœ¬kafka-consumer-groupsè„šæœ¬</li>
</ul>
<h4 id="è„šæœ¬å·¥å…·"><a href="#è„šæœ¬å·¥å…·" class="headerlink" title="è„šæœ¬å·¥å…·"></a>è„šæœ¬å·¥å…·</h4><ul>
<li><p>kafka-aclsï¼šè®¾ç½®Kafkaæƒé™</p>
</li>
<li><p>kafka-broker-api-versionsï¼šéªŒè¯ä¸åŒKafkaç‰ˆæœ¬ç›´æ¥æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„é€‚é…æ€§</p>
</li>
<li><p>kafka-configï¼šåŠ¨æ€å‚æ•°é…ç½®</p>
</li>
<li><p>kafka-console-consumerï¼šæ¶ˆè´¹ç»„è„šæœ¬</p>
<pre><code class="bash">bin/kafka-console-consumer.sh --bootstrap-server kafka-host:port --topic test-topic --group test-group --from-beginning --consumer-property enable.auto.commit=false 
#æŒ‡å®šäº† group ä¿¡æ¯ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œæ¯æ¬¡è¿è¡Œ Console Consumerï¼Œå®ƒéƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–°çš„æ¶ˆè´¹è€…ç»„æ¥æ¶ˆè´¹</code></pre>
</li>
<li><p>kafka-console-producerï¼šç”Ÿäº§è€…è„šæœ¬</p>
<pre><code class="bash">bin/kafka-console-producer.sh --broker-list kafka-host:port --topic test-topic --request-required-acks -1 --producer-property compression.type=lz4
&gt;
#æŒ‡å®šç”Ÿäº§è€…å‚æ•° acks ä¸º -1ï¼ŒåŒæ—¶å¯ç”¨äº† LZ4 çš„å‹ç¼©ç®—æ³•ã€‚è¿™ä¸ªè„šæœ¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è®©æˆ‘ä»¬ä½¿ç”¨æ§åˆ¶å°æ¥å‘ Kafka çš„æŒ‡å®šä¸»é¢˜å‘é€æ¶ˆæ¯  </code></pre>
</li>
<li><p>kafka-producer-perf-testï¼šç”Ÿäº§è€…æµ‹è¯•å·¥å…·</p>
<pre><code class="bash">bin/kafka-producer-perf-test.sh --topic test-topic --num-records 10000000 --throughput -1 --record-size 1024 --producer-props bootstrap.servers=kafka-host:port acks=-1 linger.ms=2000 compression.type=lz4
#å‘æŒ‡å®šä¸»é¢˜å‘é€äº† 1 åƒä¸‡æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯å¤§å°æ˜¯ 1KBã€‚</code></pre>
</li>
<li><p>kafka-consumer-perf-testï¼šæ¶ˆè´¹è€…æµ‹è¯•å·¥å…·</p>
<pre><code class="bash">bin/kafka-consumer-perf-test.sh --broker-list kafka-host:port --messages 10000000 --topic test-topic</code></pre>
</li>
<li><p>kafka-consumer-groupsï¼šæŸ¥çœ‹æ¶ˆè´¹ç»„ä½ç§»</p>
<pre><code class="bash">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group test-group</code></pre>
</li>
<li><p>kafka-dump-logï¼šæŸ¥çœ‹kafkaæ¶ˆæ¯æ–‡ä»¶å†…å®¹ï¼ŒåŒ…å«å„è‡ªå…ƒæ•°æ®ä¿¡æ¯</p>
<pre><code class="bash">$ bin/kafka-dump-log.sh --files ../data_dir/kafka_1/test-topic-1/00000000000000000000.log </code></pre>
</li>
<li><p>kafka-log-dirsï¼šæŸ¥è¯¢å„ä¸ªBrokerä¸Šæ—¥å¿—è·¯çº¿ä¸‹çš„ç£ç›˜å ç”¨æƒ…å†µ</p>
</li>
<li><p>kafka-mirror-makerï¼šå®ç°é›†ç¾¤æ¶ˆæ¯åŒæ­¥</p>
</li>
<li><p>kafka-preferred-replica-electionï¼šæ‰§è¡Œ Preferred Leader é€‰ä¸¾çš„</p>
</li>
<li><p>kafka-reassign-partitionsï¼šæ‰§è¡Œåˆ†åŒºå‰¯æœ¬è¿ç§»åŠå‰¯æœ¬æ–‡ä»¶è·¯å¾„è¿ç§»</p>
</li>
<li><p>kafka-topicsï¼šä¸»é¢˜ç®¡ç†</p>
</li>
</ul>
<p>æ‰€æœ‰çš„è„šæœ¬éƒ½å¯ä»¥ç”¨ â€“helpæ¥æŸ¥çœ‹é€‰é¡¹ï¼Œæ¯”å¦‚<code>./kafka-console-consumer.sh --help</code></p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>Eric</li><li class="post-copyright-link"><strong>Post link: </strong><a href="http://soda1.github.io/2023/03/01/kafka/02.%E8%BF%9B%E9%98%B6/" title="Kafkaè¿›é˜¶">http://soda1.github.io/2023/03/01/kafka/02.%E8%BF%9B%E9%98%B6/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> unless otherwise stated.</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2023/03/09/mysql/%E9%AB%98%E7%BA%A7/mysql%E6%89%A9%E5%AE%B9/" rel="prev" title="mysqlæ‰©å®¹"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">mysqlæ‰©å®¹</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2023/02/28/kafka/01.kafka%E5%85%A5%E9%97%A8/" rel="next" title="Kafkaå…¥é—¨"><span class="post-nav-text">Kafkaå…¥é—¨</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><style>.utterances {
  max-width: 100%;
}</style><script src="https://utteranc.es/client.js" repo="soda1/soda1.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 â€“ 2023 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Eric</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.2.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.9</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Searching..." value=""></div><div class="search-result-container"></div></div><div class="aplayer no-destroy" id="aplayer" data-id="308168565" data-server="netease" data-type="playlist" data-fixed="true" data-theme="#0078E7" data-loop="all" data-order="list" data-preload="auto" data-volume="0.7" data-mutex data-lrctype="0" data-listmaxheight="340px" data-storagename="metingjs"></div></body></html>